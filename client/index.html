<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Page Metadata -->
    <title>Meta-PTCG | Pokémon TCG Tabletop Simulator </title>
    <meta name="description" content="PTCG-sim-meta is an open-source Pokémon Trading Card Game (Pokémon TCG) tabletop simulator supporting single player and online multiplayer. With a focused emphasis on added features for custom Meta!">
    <meta name="keywords" content="ptcg sim,ptcg,pokemon trading card game simulator,pokemon trading card game sim,pokemon tcg simulator,pokemon tcg sim,pokemon sim,pokemon simulator,pokemon card simulator,pokemon card sim,pokemon tabletop simulator,pokemon tabletop sim,pokemon,pokemon card,pokemonsim,pokemon game sim,ptcg os,pokemon open source"/>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta http-equiv="Content-Language" content="en">
    
    <!-- OpenGraph Tags for Social Media -->
    <meta property="og:title" content="Pokémon Meta TCG Tabletop Simulator | PTCG-sim-meta"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://ptcg-sim-meta.pages.dev/src/assets/blank-logo.png"/>
    <meta property="og:url" content="https://ptcg-sim-meta.pages.dev"/>
    <meta property="og:description" content="PTCG-sim-meta is an open-source Pokémon Trading Card Game (Pokémon TCG) tabletop simulator supporting single player and online multiplayer. Simulate your favorite card game!">
    <meta property="og:site_name" content="PTCG-sim-meta">
    
    <!-- Viewport and Favicon -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="src/assets/favicon.ico" type="image/x-icon">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="src/css/modern-variables.css">
    <link rel="stylesheet" href="src/css/modern-components.css">
    <link rel="stylesheet" href="src/css/index.css">
    <link rel="stylesheet" href="src/css/glow.css">
    
    <!-- External Libraries -->
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    
    <!-- Main Application Script -->
    <script type="module" src="src/front-end.js"></script>
    
    <!-- Mobile Detection Script -->
    <script>
        window.onload = () => {
            var isMobile = /iPhone|iPad|iPod|Android|webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                alert("PTCG-sim & Meta is still in mobile development. Please use a desktop for full functionality.");
            };
        };
    </script>
</head>
<body>
    <!-- Main Container Elements -->
    <div id="cover"></div>
    <iframe id="selfContainer" class="self" src="./self-containers.html"></iframe>
    <iframe id="oppContainer" class="opp" src="./opp-containers.html"></iframe>
    <div id="stadium" class="outline stadium-outline glow-stadium"></div>
    
    <!-- Modern Chat Interface -->
    <iframe id="chatInterface" class="chat-iframe" src="./chat-interface.html"></iframe>
    
    <!-- Resizer Elements -->
    <div id="selfResizer" class="self-color"></div>
    <div id="oppResizer" class="opp-color"></div>

    <!-- Board Control Buttons -->
    <div id="boardButtonContainer">
        <!-- Self Player Actions (Left Side) -->
        <div class="player-actions self-actions">
            <div class="tooltip-modern" data-tooltip="Self GX Attack">
                <button id="selfGXButton" class="btn btn-self">
                    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    GX
                </button>
            </div>
            <div class="tooltip-modern" data-tooltip="Self VSTAR Power">
                <button id="selfVSTARButton" class="btn btn-self">
                    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2l2.4 7.4h7.6l-6 4.6 2.3 7.4-6.3-4.6-6.3 4.6 2.3-7.4-6-4.6h7.6z"/>
                    </svg>
                    VSTAR
                </button>
            </div>
            <div class="tooltip-modern" data-tooltip="Self Forte">
                <button id="selfForteButton" class="btn btn-self">
                    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm4.59-12.42L10 14.17l-2.59-2.58L6 13l4 4 8-8-1.41-1.42z"/>
                    </svg>
                    Forte
                </button>
            </div>
        </div>

        <!-- Center Actions -->
        <div class="center-actions">
            <div class="tooltip-modern" id="boardAttackButton" data-tooltip="Attack">
                <button class="btn btn-neutral">
                    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    Attack
                </button>
            </div>
            <div class="tooltip-modern" id="boardPassButton" data-tooltip="Pass turn">
                <button class="btn btn-neutral">
                    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.94-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                    </svg>
                    Pass
                </button>
            </div>
            <div class="tooltip-modern" id="turnButton" data-tooltip="Start turn">
                <button class="btn btn-neutral">
                    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/>
                    </svg>
                    Turn
                </button>
            </div>
            <div class="tooltip-modern" id="flipCoinButton" data-tooltip="Flip coin">
                <button class="btn btn-neutral">
                    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                    </svg>
                    Coin
                </button>
            </div>
            <div class="button-pair">
                <div class="tooltip-modern" id="flipBoardButton" data-tooltip="Flip board">
                    <button class="btn btn-neutral btn-compact">
                        <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M16 17.01V10h-2v7.01h-3L15 21l4-3.99h-3zM9 3L5 6.99h3V14h2V6.99h3L9 3z"/>
                        </svg>
                    </button>
                </div>
                <div class="tooltip-modern" id="refreshButton" data-tooltip="Refresh images">
                    <button class="btn btn-neutral btn-compact">
                        <svg class="icon" id="refreshIcon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                        </svg>
                        <div id="loadingCircle" style="display: none;"></div>
                    </button>
                </div>
            </div>
            <div class="tooltip-modern" id="boardUndoButton" data-tooltip="Undo last action">
                <button class="btn btn-neutral">
                    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/>
                    </svg>
                    Undo
                </button>
            </div>
        </div>

        <!-- Opponent Player Actions (Right Side) -->
        <div class="player-actions opp-actions">
            <div class="tooltip-modern" data-tooltip="Opponent GX Attack">
                <button id="oppGXButton" class="btn btn-opp">
                    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    GX
                </button>
            </div>
            <div class="tooltip-modern" data-tooltip="Opponent VSTAR Power">
                <button id="oppVSTARButton" class="btn btn-opp">
                    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2l2.4 7.4h7.6l-6 4.6 2.3 7.4-6.3-4.6-6.3 4.6 2.3-7.4-6-4.6h7.6z"/>
                    </svg>
                    VSTAR
                </button>
            </div>
            <div class="tooltip-modern" data-tooltip="Opponent Forte">
                <button id="oppForteButton" class="btn btn-opp">
                    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm4.59-12.42L10 14.17l-2.59-2.58L6 13l4 4 8-8-1.41-1.42z"/>
                    </svg>
                    Forte
                </button>
            </div>
        </div>
    </div>

    <!-- Top Navigation Buttons -->
    <div id="topButtonContainer">
        <button id="p1Button" class="selected-page">1P</button>
        <button id="p2Button" class="not-selected-page">2P</button>
        <button id="deckImportButton" class="not-selected-page">Import</button>
        <button id="settingsButton" class="not-selected-page">Settings</button>
    </div>
    <div id="greyFiller"></div>

    <!-- Player 1 Interface Box -->
    <div id="p1Box" class="sidebox">
        <div id="chatbox">
            <strong>Welcome to the Meta PTCG-sim!</strong>
            <p>
                <div style="text-align: center;">                        
                    <h3>PTCG-Sim Latest Changelog</h3>
                    <strong id="changelogLink" style="cursor: pointer; text-decoration: none; color: #ffcc00; border-bottom: 1px solid #ffcc00;">v1.5.1 Ϟ(๑⚈ ․̫ ⚈๑)⋆</strong>
                    <h3>META PTCG Latest Changelog</h3>
                    <strong id="metaChangelogLink" style="cursor: pointer; text-decoration: none; color: #ff9900; border-bottom: 1px solid #ff9900; margin-left: 10px;">Meta v0.1.0 ✧(≖ ヮ ≖)✧</strong>
                    </div>
                    <h5><p style="font-size: 90%;">PTCG-sim-meta is an <a href="https://github.com/Envoyofhell/ptcg-sim-meta" target="_blank">open-source</a> fork of <a href="https://github.com/xxmichaellong/ptcg-sim" target="_blank">ptcg-sim</a> Pokémon Trading Card Game (Pokémon TCG) tabletop simulator. It supports single player and online multiplayer.</p> 
                        <p style="font-size: 90%;">Use the <strong>Import</strong> tab above to import your deck, then press <strong>Set Up</strong> to start a game.</p>
                        <p style="font-size: 90%;">Drag or use keybinds (hold <span class="shift-font">shift</span>) to move cards. </p>
                        <p style="font-size: 90%;">See the <strong>Options</strong> button below to import, export, and replay games.</p>
                        <p style="font-size: 90%;">We have a lot in the works with more coming soon so stick around!</p></h5>
                
            </p>
            
        
            <!-- Existing buttons and links -->
            <button id="tutorialButton">Watch Tutorial</button>
            <br><br>
            <div id="links">
                <div id="discordLink"><strong><a href="https://discord.gg/gehvP4cxWK" target="_blank">🕹️ Join Us On Discord 🕹️</a></strong></div>
                <div id="donationsLink">🎁 Sponsors & Donations</div> 
            </div>
            <div id="line"></div>
        </div>
        <div id="chatboxButtonContainer" class="chat-button-container">
            <button id="attackButton" class="self-color">Attack</button>
            <button id="passButton" class="self-color">Pass</button>
            <button id="undoButton" class="self-color">Undo</button>
            <button id="FREEBUTTON" class="self-color">🔥</button>
        </div>
        <input id="messageInput" type="text" placeholder="Type your message here...">
        <div id="bottomP1ButtonContainer" class="sidebox-button-container">
            <button id="setupButton" class="self-color">Set Up</button>
            <button id="resetButton" class="self-color">Reset</button>
            <button id="setupBothButton" class="neutral-color">Set Up Both</button>
            <button id="resetBothButton" class="neutral-color">Reset Both</button>
            <button id="optionsButton" class="neutral-color">Options</button>
        </div>
    </div>

    <!-- Player 2 Interface Box -->
    <div id="p2Box" class="sidebox">
        <div id="p2ExplanationBox">
            <strong>Online Multiplayer Mode</strong>
            <br><br>
            Enter or generate a unique room ID to share with your friends. Players must enter the same ID (case-sensitive) to join.
        </div>
        <div id="lobby">
            <input id="nameInput" type="text" placeholder="Name">
            <div id="roomId">
                <input id="roomIdInput" type="text" placeholder="Room ID">
                <button id="copyButton">
                    <img src="https://www.svgrepo.com/show/309480/copy.svg" alt="Copy">
                </button>                
                <button id="generateIdButton">Generate</button>
            </div>
            <div id="coachingModeLabel">
                <input type="checkbox" id="coachingModeCheckbox">
                <label style="cursor: pointer;" for="coachingModeCheckbox">Enable board flip <span style="font-style: italic; font-size: smaller;">(both players must enable)</span></label>
            </div>
            <div id="spectatorModeLabel">
                <input type="checkbox" id="spectatorModeCheckbox">
                <label style="cursor: pointer;" for="spectatorModeCheckbox">Join as spectator</label>
            </div>
            <div id="joinRoomButton"> Join Room </div>
        </div>
        <div id="connectedRoom">
            <div id="roomHeader">
                <div id ="roomHeaderText"></div>
                <button id="roomHeaderCopyButton">
                    <img src="https://www.svgrepo.com/show/309480/copy.svg" alt="Copy">
                </button>
        </div>
            <div id="p2Chatbox"></div>
            <div id="p2ChatboxButtonContainer" class="chat-button-container">
                <button id="p2AttackButton" class="self-color">Attack</button>
                <button id="p2PassButton" class="self-color">Pass</button>
                <!-- <button id="p2UndoButton" class="self-color">Undo</button> -->
                <button id="p2FREEBUTTON" class="self-color">⚡</button>
            </div>
            <input id="p2MessageInput" type="text" placeholder="Type your message here...">
            <div id="p2BottomButtonContainer" class="sidebox-button-container">
                <button id="p2SetupButton" class="self-color">Set Up</button>
                <button id="p2ResetButton" class="self-color">Reset</button>
                <button id="leaveRoomButton" class="neutral-color">Leave Room</button>
                <button id="p2OptionsButton" class="neutral-color">Options</button>
            </div>
        </div>
       
    </div>

    <!-- Deck Import Interface -->
    <div id="deckImport" class="sidebox">
        <div>
            <button id="deckBuilderButton">Deck Builder</button>
            <button id="importExportGameStateButton">Import/Export Game</button>
            <!-- <button id="decklistButton">New format decks</button>
            <script>
                const decklistButton = document.getElementById('decklistButton');
                    decklistButton.addEventListener('click', function() {
                    window.open('https://drive.google.com/drive/folders/1Vk04FldAH9dTzOI38O_KCUP4zPhm6pyn', '_blank');
                });
            </script> -->
            </div>
        <div id="importButtonContainer">
            <button id="mainImportHeaderButton" class="main-select">Main</button>
            <button id="altImportHeaderButton">Alt (1P only)</button>
        </div>
        <textarea id="mainDeckImportInput" spellcheck="false"></textarea>
        <script>
            document.getElementById("mainDeckImportInput").placeholder = "Paste your main decklist here. \n\nClick the book 📖 to look through popular decks or click the wand 🪄 for a random deck! \n\nFor uploading custom images, write the quantity and name (i.e. 2 Pikachu) and click on the 'Import' button. \n\nInternational languages are supported for cards using Limitless URLs.";
        </script>          
        <textarea id="altDeckImportInput" spellcheck="false"></textarea>
        <script>
            document.getElementById("altDeckImportInput").placeholder = "Paste your alternative decklist here if you are playing against yourself. \n\nClick the book 📖 to look through popular decks or click the wand 🪄 for a random deck! \n\nFor uploading custom images, write the quantity and name (i.e. 2 Pikachu) and click on the 'Import' button. \n\nInternational languages are supported for cards using Limitless URLs.";
        </script>
        <div id="importBottom">
            <button id="decklistsButton">📖</button>
            <button id="importButton">Import</button>
            <button id="confirmButton">Confirm</button>
            <button id="cancelButton">Cancel</button>
            <button id="saveButton" class="neutral-color">Save</button>
            <div id="decklistsContextMenu" class="decklists-context-menu"></div>
            <button id="randomButton">🪄</button>
            <div id="successText">Success!</div><div id="failedText">Error!</div><div id="loadingText"></div><div id="invalidText">Not allowed!</div>
        </div>
        <div id="uploadButtonsContainer">
            <label for="csvFile" id="uploadFileButton" class="self-color">Upload File</label>
            <input type="file" id="csvFile" accept=".csv" style="display:none;">
            <button id="changeCardBackButton" class="self-color">Change Card Back</button>
            <div class="language-container">
                <button id="changeLanguageButton" class="neutral-color">Language: English</button>
                <div id="languageDropdown">
                    <ul>
                        <li>English</li>
                        <li>French</li>
                        <li>German</li>
                        <li>Italian</li>
                        <li>Portuguese</li>
                        <li>Spanish</li>
                    </ul>
                </div>
            </div>
        </div>       
        <button id="saveCurrentButton" class="self-color">Save Current Deck</button>                
    </div>
    
    <!-- Settings Interface -->
    <div id="settings" class="sidebox">
        <div id="settingsToggles">
            <div>
                <input type="checkbox" id="darkModeCheckbox">
                <label for="darkModeCheckbox">Dark mode</label>
            </div>
            <div>
                <input type="checkbox" id="showZonesCheckbox">
                <label for="showZonesCheckbox">Hide containers</label>
            </div>
            <div>
                <input type="checkbox" id="hideHandCheckbox">
                <label for="hideHandCheckbox">Hide opponent's hand (1P mode)</label>
            </div>
        </div>
        <button id="changeBackgroundButton" class="neutral-color">Change background</button>
        <br>
        <div id="keybindReminder">
          Hold (<span class="shift-font">shift</span>) to view keybinds
        </div>
        <div id="twitterDescription">
            <div>Please reach out if you have any questions, suggestions, bugs etc.!</div>
            <a href="https://x.com/Envoy_Of_Hell" target="blank" rel="noopener noreferrer">
                <div id="twitterHandle">
                    <img src="https://images.freeimages.com/image/large-previews/9fe/x-twitter-light-grey-logo-5694251.png">
                    <span id="username">@Envoy_Of_Hell</span>
                </div>
            </a>
        </div>
    </div>
      
    <!-- Card Context Menu -->
    <div id="cardContextMenu" class="card-context-menu">
        <ul>
            <li id="abilityCounterButton">Toggle ability/effect</li>
            <li id="damageCounterButton">Damage counter</li>
            <li id="specialConditionButton">Special condition</li>
            <li id="miscCounterButton">Misc Markers</li>

            <li id="prizesHeader">Prizes</li>
            <li id="shufflePrizesButton">Shuffle prizes</li>
            <li id="revealHidePrizesButton">Reveal/hide prizes</li>
            <li id="lookPrizesButton">Look/cover prizes</li>

            <li id="handHeader">Hand</li>
            <li id="discardHandButton">Discard hand</li>
            <li id="shuffleHandButton">Shuffle hand into deck</li>
            <li id="shuffleHandBottomButton">Shuffle hand to bottom</li>
            <li id="lookHandButton">Look/cover hand</li>
            <li id="randomHandButton">Pick random card</li>

            <li id="deckHeader">Deck</li>
            <li id="shuffleDeckButton">Shuffle deck</li>
            <li id="drawButton">Draw card(s)</li>
            <li id="viewTopButton">View top card(s)</li>
            <li id="viewBottomButton">View bottom card(s)</li>

            <li id="boardHeader">Playboard</li>
            <li id="discardBoardButton">Discard all</li>
            <li id="handBoardButton">Move all to hand</li>
            <li id="shuffleBoardButton">Shuffle all into deck</li>
            <li id="lostZoneBoardButton">Lost Zone all</li>

            <li id="moveButton">Move card...
                <ul class="card-sub-menu">
                    <li id="moveToBoardButton">to Board</li>
                    <li id="moveToTopButton">to Deck (top)</li>
                    <li id="moveToBottomButton">to Deck (bottom)</li>
                    <li id="switchWithTopButton">to Deck (switch)</li>
                    <li id="shuffleIntoDeckButton">to Deck (shuffle)</li>
                </ul>
            </li>
            <li id="revealHideButton">Reveal/hide card</li>
            <li id="changeButton">Change type...
                <ul class="card-sub-menu">
                    <li id="changeToEnergyButton">to Energy</li>
                    <li id="changeToToolButton">to Tool</li>
                    <li id="changeToPokémonButton">to Pokémon</li>
                </ul>
            </li>
        </ul>
    </div>

    <!-- Options Context Menu -->
    <div id="optionsContextMenu">
        <div id="exitReplay" style="display:none">Exit replay mode</div>
        <div id="jsonReplayDiv"><label for="jsonReplay" id="importReplay" style="cursor: pointer;">Enter replay mode</label>
            <input type="file" id="jsonReplay" accept=".json" style="display:none;" />
        </div>
        <div id="jsonDiv"><label for="jsonFile" id="importState" style="cursor: pointer;">Import game state</label>
            <input type="file" id="jsonFile" accept=".json" style="display:none;" />
        </div>
        <div id="exportState">Export game state</div>
        <div id="exportLog">Export battle log</div>
        <div id="clearLog">Clear battle log</div>
        <div id="fullscreenButton">Full screen</div>
    </div>

    <!-- Keybind Modal -->
    <div id="keybindModal">
        <div class="keybind-section-container">
            <div class="keybind-section">
                <div class="keybind-column">
                    <h1>Move card...</h1>
                    <ul>
                        <li>to Hand <code>[h]</code></li>
                        <li>to Discard <code>[d]</code></li>
                        <li>to Bench <code>[b]</code></li>
                        <li>to Active <code>[a]</code></li>
                        <li>to Stadium <code>[g]</code></li>
                        <li>to Lost Zone <code>[l]</code></li>
                        <li>to Prizes <code>[p]</code></li>
                        <li>to Board <code>[space]</code></li>
                        <li>to Deck (top) <code>[↑]</code></li>
                        <li>to Deck (bottom) <code>[↓]</code></li>
                        <li>to Deck (switch) <code>[→]</code></li>
                        <li>to Deck (shuffle)<code>[s]</code></li>
                    </ul>
                </div>
                <div class="keybind-column">
                    <h1>Deck</h1>
                    <ul>
                        <li>Shuffle deck<code>[s]</code></li>
                        <li>Draw card(s)<code>[1-9]</code></li>
                        <li>View top card(s)<code>[alt + 1-9]</code></li>
                        <li>View bottom card(s)<code>[ctrl + 1-9]</code></li>
                        <li>View <code>[v]</code></li>
                    </ul>
                </div>
                <div class="keybind-column">
                    <h1>Hand</h1>
                    <ul>
                        <li>Discard hand<code>[alt + d]</code></li>
                        <li>Shuffle hand into deck <code>[alt + s]</code></li>
                        <li>Shuffle hand to bottom <code>[alt + ↓]</code></li>
                    </ul>
                </div>
                <div class="keybind-column">
                    <h1>Playboard</h1>
                    <ul>
                        <li>Discard all<code>[enter]</code></li>
                        <li>Move all to hand<code>[alt + enter]</code></li>
                        <li>Shuffle all into deck<code>[/]</code></li>
                    </ul>
                </div>
            </div>
            <div class="keybind-section">
                <div class="keybind-column">
                    <h1>Card actions</h1>
                    <ul>
                        <li>Attach <code>[q]</code></li>
                        <li>Evolve <code>[e]</code></li>
                        <li>View (for cards in play, press twice) <code>[v]</code></li>
                        <li>Toggle ability/effect<code>[w]</code></li>
                        <li>Damage counter</li>
                        <ul>
                            <li>Increase <code>[1-9]</code></li>
                            <li>Decrease <code>[alt + 1-9]</code></li>
                            <li>Remove <code>[0]</code></li>
                        </ul>
                        <li>Special condition</li>
                        <ul>
                            <li>Add/Toggle <code>[y]</code></li>
                            <li>Remove <code>[alt + y]</code></li>
                        </ul>
                        <li>Rotate card(s)<code>[r]</code></li>
                        <li>Rotate BREAK <code>[alt + r]</code></li>
                        <li>Look/cover card (only yourself)<code>[c]</code></li>
                        <li>Hide card (both players)<code>[z]</code></li>
                        <li>Reveal card (both players)<code>[alt + z]</code></li>
                        <li>Put face-down card in active<code>[z] → [a]</code></li>
                        <li>Change type...</li>
                        <ul>
                            <li>to Tool <code>[alt + t]</code></li>
                            <li>to Energy <code>[alt + e]</code></li>
                            <li>to Pokémon <code>[alt + p]</code></li>
                        </ul>
                    </ul>
                </div>
                <div class="keybind-column">
                    <h1>General</h1>
                    <ul>
                        <li>Set up <code>[alt + n]</code></li>
                        <li>Reset <code>[alt + r]</code></li>
                        <li>Start turn <code>[alt + t]</code></li>
                        <li>Flip coin <code>[f]</code></li>
                        <li>Flip board <code>[alt + f]</code></li>
                        <li>Announce mulligan <code>[m]</code></li>
                        <li>Undo <code>[u]</code></li>
                        <li>Close popups <code>[esc]</code></li>
                        <li>Refresh images <code>[r]</code></li>
                    </ul>
                </div>
            </div>
        </div>
        <div style="position: absolute; bottom: 0; left: 20px;">
            <p style="font-size: 1.5vh;"><strong>For macOS:</strong> Use <code>option</code> instead of <code>alt</code>
            </p>
        </div>
    </div>

    <!-- Decklist Tables -->
    <table id="decklistTable">
        <thead>
            <tr>
                <th>QTY</th>
                <th>Name</th>
                <th>Type</th>
                <th>URL</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <table id="selfCurrentDecklistTable" style="display: none;"></table>
    <table id="oppCurrentDecklistTable" style="display: none;"></table>

    <!-- Special Pages/Modals -->
    <div id="videoContainer"></div>
    
    <!-- Changelog Container - Content loaded dynamically -->
    <div id="changelog"></div>
    
    <!-- Donations Page -->
    <div id="donationsPage">
        <h2>Sponsors & Donations</h2>

        <p>Hi everyone! I'm Michael/Xiao Xiao Long. I'm a 21-year-old from Guelph, Canada, who started programming in the fall of 2023. I've been playing the Pokémon TCG for over 8 years, and I spent the last 3 months building PTCG-sim, a free tool for the community to use to test and play our favorite card game.</p>

        <p>I publicly launched the sim on Christmas, and it has already grown an incredible community of players and developers. There's a lot more to do, and I could use as much help as I can get!</p>

        <p>Should you find joy in using the sim and wish to support its ongoing development, you can sponsor me/the project through one of the links below. However, please know that sponsorship is completely optional. Your enjoyment of the sim is contribution enough, and I'm thrilled to have you as part of our community :)</p>

        <p>-XXL's Links: <3</p>

        <h3><a href="https://github.com/sponsors/xxmichaellong?o=esc" target="_blank" style="color: rgb(91, 91, 173); text-decoration: underline;">Github Sponsors Link</a></h3>
        <h3><a href="https://www.paypal.com/donate/?hosted_button_id=VWFSCL73GDHF4" target="_blank"  style="color: rgb(91, 91, 173); text-decoration: underline;">Paypal Donation Link</a></h3>
      
      </div>

    <!-- Changelog Scripts -->
    <script src="src/changelogs/main-changelog.js"></script>
    <script src="src/changelogs/meta-changelog.js"></script>
    <script src="src/changelogs/changelog.js"></script>

    <!-- Board Button Event Listeners -->
    <script type="module">
        import { VSTARGXFunction } from './src/actions/general/VSTAR-GX.js';
        import { appendMessage } from './src/setup/chatbox/append-message.js';
        import { determineUsername } from './src/setup/general/determine-username.js';
        import { socket, systemState } from './src/front-end.js';
        import { attack, pass } from './src/actions/chat-buttons/chat-buttons.js';
        
        // Simple undo function for board button that just adds a message
        const boardUndo = (user) => {
            console.log(`Board undo called for user: ${user}`);
            const message = determineUsername(user) + ' took back their last move!';
            boardAppendMessage(user, message, 'announcement', false);
        };
        
        // Chat region tracking for pointer events
        let chatRegions = [];
        
        // Function to check if a point is within any chat region
        function isPointInChatRegion(x, y) {
            return chatRegions.some(region => 
                x >= region.left && x <= region.right && 
                y >= region.top && y <= region.bottom
            );
        }
        
        // Handle iframe pointer events dynamically with smart click detection
        function setupDynamicPointerEvents() {
            const chatFrame = document.getElementById('chatInterface');
            if (!chatFrame) return;
            
            // Global click handler for smart activation
            document.addEventListener('mousedown', (e) => {
                const clickedInChat = isPointInChatRegion(e.clientX, e.clientY);
                
                if (clickedInChat) {
                    // Enable iframe pointer events for chat interaction
                    chatFrame.style.pointerEvents = 'auto';
                    console.log('Chat region clicked - enabling iframe interaction');
                    
                    // Disable after a short delay to prevent blocking other elements
                    setTimeout(() => {
                        chatFrame.style.pointerEvents = 'none';
                    }, 200);
                } else {
                    // Clicked outside chat - ensure iframe doesn't block
                    chatFrame.style.pointerEvents = 'none';
                    
                    // Check if we clicked on a board button
                    const boardButton = e.target.closest('#boardButtonContainer button, .btn');
                    if (boardButton) {
                        console.log('Board button clicked while chat inactive:', boardButton.textContent);
                        
                        // Send deactivation message to chat
                        if (chatFrame.contentWindow) {
                            chatFrame.contentWindow.postMessage({
                                type: 'deactivateChat'
                            }, '*');
                        }
                    }
                }
            });
            
            // Handle double-click for chat activation
            document.addEventListener('dblclick', (e) => {
                if (isPointInChatRegion(e.clientX, e.clientY)) {
                    chatFrame.style.pointerEvents = 'auto';
                    setTimeout(() => {
                        chatFrame.style.pointerEvents = 'none';
                    }, 500);
                }
            });
        }
        
        // IRC Chat interface message handler
        window.addEventListener('message', (event) => {
            if (event.origin !== window.location.origin) return;
            
            const { type, data } = event.data;
            
            switch (type) {
                case 'chatRegions':
                    // Update chat regions for pointer event handling
                    chatRegions = data.regions || [];
                    console.log('Updated chat regions:', chatRegions);
                    break;
                case 'joinRoom':
                    // Connect IRC chat interface join room to original 2P system
                    const { playerName, roomId, isSpectator, coachingMode } = data;
                    
                    // Set the values in the original 2P interface
                    const nameInput = document.getElementById('nameInput');
                    const roomIdInput = document.getElementById('roomIdInput');
                    const spectatorCheckbox = document.getElementById('spectatorModeCheckbox');
                    const coachingCheckbox = document.getElementById('coachingModeCheckbox');
                    
                    if (nameInput) nameInput.value = playerName;
                    if (roomIdInput) roomIdInput.value = roomId;
                    if (spectatorCheckbox) spectatorCheckbox.checked = isSpectator;
                    if (coachingCheckbox) coachingCheckbox.checked = coachingMode;
                    
                    // Set system state
                    systemState.p2SelfUsername = playerName;
                    systemState.roomId = roomId;
                    
                    // Emit join game event
                    socket.emit('joinGame', roomId, playerName, isSpectator);
                    
                    // Send confirmation back to IRC chat
                    const chatFrame = document.getElementById('chatInterface');
                    if (chatFrame && chatFrame.contentWindow) {
                        chatFrame.contentWindow.postMessage({
                            type: 'roomJoined',
                            data: { roomId, playerName }
                        }, '*');
                    }
                    break;
                    
                case 'leaveRoom':
                    // Handle leave room from IRC chat interface
                    const leaveRoomButton = document.getElementById('leaveRoomButton');
                    if (leaveRoomButton) {
                        leaveRoomButton.click();
                    }
                    break;
                    
                case 'chatMessage':
                    // Handle chat messages from IRC interface
                    const { channel, message, username: chatUsername, messageType } = data;
                    
                    // Determine message type and format
                    let displayMessage = message;
                    let msgType = 'message';
                    
                    if (messageType === 'emoji') {
                        displayMessage = message; // Just the emoji
                        msgType = 'emoji';
                        // Use the original appendMessage function directly to avoid double processing
                        originalAppendMessage('self', `${chatUsername}: ${displayMessage}`, msgType);
                    } else {
                        // Regular message
                        originalAppendMessage('self', `${chatUsername}: ${displayMessage}`, msgType);
                    }
                    
                    // Send the message back to IRC chat to display it there
                    sendToIRCChat('newMessage', {
                        type: 'self',
                        content: displayMessage,
                        username: chatUsername,
                        timestamp: new Date().toISOString(),
                        tab: channel,
                        messageType: msgType,
                        processed: false
                    });
                    
                    // If in multiplayer, send to other players
                    if (systemState.isTwoPlayer && socket) {
                        socket.emit('message', displayMessage);
                    }
                    break;
                    
                case 'playerAction':
                    // Handle player actions from IRC interface
                    const { action, username: actionUsername } = data;
                    
                    // Execute the actual action (this will generate its own message)
                    switch (action) {
                        case 'attack':
                            const attackButton = systemState.isTwoPlayer ? 
                                document.getElementById('p2AttackButton') : 
                                document.getElementById('attackButton');
                            if (attackButton) attackButton.click();
                            break;
                        case 'pass':
                            const passButton = systemState.isTwoPlayer ? 
                                document.getElementById('p2PassButton') : 
                                document.getElementById('passButton');
                            if (passButton) passButton.click();
                            break;
                        case 'undo':
                            boardUndo('self');
                            break;
                        case 'coin':
                            // Add coin flip functionality
                            const result = Math.random() < 0.5 ? 'Heads' : 'Tails';
                            boardAppendMessage('self', `${actionUsername} flipped a coin: ${result}!`, 'announcement');
                            break;
                    }
                    break;
                    
                case 'chatClosed':
                    // Handle chat window being closed
                    console.log('IRC Chat window closed');
                    break;
                    
                case 'sidebarOpened':
                    // Adjust main layout for 3-panel view
                    document.body.classList.add('sidebar-open');
                    console.log('Sidebar opened - adjusting to 3-panel layout');
                    break;
                    
                case 'sidebarClosed':
                    // Restore main layout to 2-panel view
                    document.body.classList.remove('sidebar-open');
                    console.log('Sidebar closed - restoring 2-panel layout');
                    break;
            }
        });
        
        // Function to send messages to IRC chat
        window.sendToIRCChat = function(type, data) {
            const chatFrame = document.getElementById('chatInterface');
            if (chatFrame && chatFrame.contentWindow) {
                try {
                    chatFrame.contentWindow.postMessage({ type, data }, '*');
                    console.log('Sent to IRC chat:', type, data);
                } catch (error) {
                    console.error('Failed to send message to IRC chat:', error);
                }
            } else {
                console.warn('IRC chat frame not available');
            }
        };
        
        // Send game messages to IRC chat (without overriding the global function)
        const originalAppendMessage = appendMessage;
        
        // Create a wrapper function that also sends to IRC chat
        const appendMessageWithIRC = function(user, message, type, isFromSocket = false) {
            console.log('appendMessageWithIRC called:', { user, message, type, isFromSocket });
            
            // Call original function
            originalAppendMessage(user, message, type, isFromSocket);
            
            // Enhanced duplicate prevention - skip messages that are already from IRC chat interface
            const isFromIRCChat = message.includes(':') && (
                message.includes('You:') || 
                message.includes('Player') || 
                message.includes('Opponent:') ||
                message.includes('Guest:') ||
                /^[A-Za-z]+:/.test(message) // Any username pattern
            );
            
            // Skip if message is from IRC, socket, or contains certain patterns
            if (!message.includes('[battle]') && 
                !isFromSocket && 
                !message.includes('IRC Chat') && 
                !isFromIRCChat &&
                !message.includes('copied to clipboard') &&
                !message.includes('Generated room:') &&
                !message.includes('Auto-assigned trainer')) {
                
                // Enhanced duplicate prevention with timestamp
                const timestamp = new Date().getTime();
                const messageKey = `${user}-${message}-${type}-${Math.floor(timestamp / 1000)}`; // Group by second
                
                if (window.lastSentMessage !== messageKey) {
                    window.lastSentMessage = messageKey;
                    
                    setTimeout(() => {
                        let channel = 'battle';
                        let messageType = 'system';
                        
                        // Better message type classification
                        if (type === 'announcement') {
                            channel = 'battle';
                            messageType = 'announcement';
                        } else if (type === 'message') {
                            channel = systemState.isTwoPlayer ? 'multiplayer' : 'battle';
                            messageType = user === 'self' ? 'self' : 'opp';
                        } else if (type === 'player') {
                            channel = 'battle';
                            messageType = 'game-action';
                        } else if (type === 'emoji') {
                            channel = 'battle';
                            messageType = 'emoji';
                        } else {
                            messageType = 'system';
                        }
                        
                        // Determine username for display
                        let displayUsername = 'System';
                        if (type === 'player' || type === 'message') {
                            displayUsername = user === 'self' ? 
                                (systemState.p2SelfUsername || systemState.selfUsername || 'You') :
                                (systemState.p2OppUsername || systemState.oppUsername || 'Opponent');
                        }
                        
                        // Send in the new message format that the IRC chat expects
                        sendToIRCChat('newMessage', {
                            type: messageType,
                            content: message,
                            username: displayUsername,
                            timestamp: new Date().toISOString(),
                            tab: channel,
                            processed: false
                        });
                    }, 50);
                    
                    // Clear the duplicate check after a short delay
                    setTimeout(() => {
                        if (window.lastSentMessage === messageKey) {
                            window.lastSentMessage = null;
                        }
                    }, 2000);
                }
            }
        };
        
        // Use the wrapper for board button actions
        const boardAppendMessage = appendMessageWithIRC;
        
        // Ensure IRC chat iframe is loaded
        const chatFrame = document.getElementById('chatInterface');
        if (chatFrame) {
            chatFrame.addEventListener('load', function() {
                console.log('IRC Chat iframe loaded');
                
                // Setup dynamic pointer events
                setTimeout(() => {
                    setupDynamicPointerEvents();
                }, 200);
                
                // Send a test message to verify communication
                setTimeout(() => {
                    sendToIRCChat('gameMessage', {
                        channel: 'system',
                        type: 'system',
                        username: 'System',
                        message: 'IRC Chat interface connected'
                    });
                }, 500);
            });
        }
        
        // Wait for the page to load
        document.addEventListener('DOMContentLoaded', function() {
            // Self player buttons
            const selfGXButton = document.getElementById('selfGXButton');
            const selfVSTARButton = document.getElementById('selfVSTARButton');
            const selfForteButton = document.getElementById('selfForteButton');
            
            // Opponent player buttons
            const oppGXButton = document.getElementById('oppGXButton');
            const oppVSTARButton = document.getElementById('oppVSTARButton');
            const oppForteButton = document.getElementById('oppForteButton');
            
            // Center buttons (get the actual button elements inside the tooltip divs)
            const boardUndoButton = document.querySelector('#boardUndoButton button');
            const boardAttackButton = document.querySelector('#boardAttackButton button');
            const boardPassButton = document.querySelector('#boardPassButton button');
            const flipCoinButton = document.querySelector('#flipCoinButton button');
            
            // Coin flip function
            const flipCoin = (user) => {
                const result = Math.random() < 0.5 ? 'Heads' : 'Tails';
                const username = determineUsername(user);
                const message = `${username} flipped a coin: ${result}!`;
                boardAppendMessage(user, message, 'announcement', false);
            };
            
            // Add event listeners for self buttons
            if (selfGXButton) {
                selfGXButton.addEventListener('click', () => VSTARGXFunction('self', 'GX'));
            }
            if (selfVSTARButton) {
                selfVSTARButton.addEventListener('click', () => VSTARGXFunction('self', 'VSTAR'));
            }
            if (selfForteButton) {
                selfForteButton.addEventListener('click', () => VSTARGXFunction('self', 'Forte'));
            }
            
            // Add event listeners for opponent buttons
            if (oppGXButton) {
                oppGXButton.addEventListener('click', () => VSTARGXFunction('opp', 'GX'));
            }
            if (oppVSTARButton) {
                oppVSTARButton.addEventListener('click', () => VSTARGXFunction('opp', 'VSTAR'));
            }
            if (oppForteButton) {
                oppForteButton.addEventListener('click', () => VSTARGXFunction('opp', 'Forte'));
            }
            
            // Add event listeners for center buttons
            if (boardUndoButton) {
                boardUndoButton.addEventListener('click', () => boardUndo('self'));
            }
            if (boardAttackButton) {
                boardAttackButton.addEventListener('click', () => attack('self'));
            }
            if (boardPassButton) {
                boardPassButton.addEventListener('click', () => pass('self'));
            }
            if (flipCoinButton) {
                flipCoinButton.addEventListener('click', () => flipCoin('self'));
            }
        });
    </script>

</body>
</html>
