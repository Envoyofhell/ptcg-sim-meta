<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IRC Chat Interface</title>
    <link rel="stylesheet" href="src/css/modern-variables.css">
    <link rel="stylesheet" href="src/css/modern-components.css">
    <link rel="stylesheet" href="src/css/chat-interface.css">
</head>
<body>
    <!-- Main IRC Chat Window -->
    <div class="irc-chat-window" id="ircChatWindow">
        <!-- Title Bar with Drag Handle -->
        <div class="irc-title-bar" id="ircTitleBar">
            <div class="irc-title">
                <span class="irc-icon">üí¨</span>
                <span id="ircTitle">PTCG Chat</span>
                <span class="connection-status" id="connectionStatus">‚óè</span>
            </div>
            
            <!-- Room Sharing Box (shown in multiplayer) -->
            <div class="room-sharing-box" id="roomSharingBox" style="display: none;">
                <div class="room-share-info">
                    <span class="room-share-label">Room:</span>
                    <span class="room-share-id" id="roomShareId">-</span>
                </div>
                <button class="room-share-btn" id="roomShareBtn" title="Copy Room ID">üìã</button>
                <button class="room-share-btn" id="roomLinkBtn" title="Copy Room Link">üîó</button>
            </div>
            
            <div class="irc-controls">
                <button class="irc-btn irc-btn-minimize" id="minimizeBtn" title="Minimize">_</button>
                <button class="irc-btn irc-btn-maximize" id="maximizeBtn" title="Maximize">‚ñ°</button>
                <button class="irc-btn irc-btn-close" id="closeBtn" title="Close">√ó</button>
        </div>
    </div>

        <!-- IRC Channel Tabs -->
        <div class="irc-channel-tabs" id="ircChannelTabs">
            <div class="irc-tab active" data-channel="battle" id="battleTab">
                <span>#battle</span>
                <span class="unread-count" id="battleUnread">0</span>
            </div>
            <div class="irc-tab" data-channel="multiplayer" id="multiplayerTab">
                <span>#multiplayer</span>
                <span class="unread-count" id="multiplayerUnread">0</span>
            </div>
            <div class="irc-tab" data-channel="system" id="systemTab">
                <span>#system</span>
                <span class="unread-count" id="systemUnread">0</span>
        </div>
            </div>
            
        <!-- IRC Chat Content -->
        <div class="irc-content" id="ircContent">
            <!-- Battle Channel -->
            <div class="irc-channel active" id="battleChannel">
                <div class="irc-messages" id="battleMessages">
                    <div class="irc-message system">
                        <span class="timestamp">[00:00]</span>
                        <span class="nick">*</span>
                        <span class="message">Welcome to #battle - Game actions and battle chat</span>
                    </div>
                </div>
                
                <!-- Battle Action Buttons -->
                <div class="irc-action-bar">
                    <button class="action-btn btn-attack" id="ircAttackBtn">‚öîÔ∏è Attack</button>
                    <button class="action-btn btn-pass" id="ircPassBtn">‚è≠Ô∏è Pass</button>
                    <button class="action-btn btn-undo" id="ircUndoBtn">‚Ü∂ Undo</button>
                    <button class="action-btn btn-coin" id="ircCoinBtn">ü™ô Coin</button>
                </div>
                
                <!-- Emoji Quick Actions -->
                <div class="emoji-bar">
                    <button class="emoji-btn" data-emoji="üëç" title="Thumbs up">üëç</button>
                    <button class="emoji-btn" data-emoji="üëé" title="Thumbs down">üëé</button>
                    <button class="emoji-btn" data-emoji="üòÑ" title="Happy">üòÑ</button>
                    <button class="emoji-btn" data-emoji="üò¢" title="Sad">üò¢</button>
                    <button class="emoji-btn" data-emoji="üî•" title="Fire">üî•</button>
                    <button class="emoji-btn" data-emoji="‚ö°" title="Lightning">‚ö°</button>
                    <button class="emoji-btn" data-emoji="üíØ" title="100">üíØ</button>
                    <button class="emoji-btn" data-emoji="üéâ" title="Party">üéâ</button>
                    <button class="emoji-btn" data-emoji="üò±" title="Shocked">üò±</button>
                    <button class="emoji-btn" data-emoji="ü§î" title="Thinking">ü§î</button>
                </div>
                </div>

            <!-- Multiplayer Channel -->
            <div class="irc-channel" id="multiplayerChannel">
                <div class="irc-messages" id="multiplayerMessages">
                    <div class="irc-message system">
                        <span class="timestamp">[00:00]</span>
                        <span class="nick">*</span>
                        <span class="message">Welcome to #multiplayer - Player chat and room communication</span>
                    </div>
                    <div class="irc-message system">
                        <span class="timestamp">[00:00]</span>
                        <span class="nick">*</span>
                        <span class="message">üí¨ Chat with other players in your room here</span>
                    </div>
                    <div class="irc-message system">
                        <span class="timestamp">[00:00]</span>
                        <span class="nick">*</span>
                        <span class="message">üéÆ Join a room below to start chatting with opponents</span>
                </div>
            </div>

                <!-- Multiplayer Controls -->
                <div class="irc-multiplayer-controls" id="multiplayerControls">
                    <div class="room-section">
                        <div style="display: flex; gap: 4px;">
                            <input type="text" id="playerNameInput" placeholder="Trainer name (auto if empty)" class="irc-input" style="flex: 1;">
                            <button class="action-btn btn-generate" id="generateTrainerBtn" title="Generate random Pokemon trainer">üë§</button>
                        </div>
                        <div style="display: flex; gap: 4px;">
                            <input type="text" id="roomIdInput" placeholder="Pokemon Location + Numbers" class="irc-input" style="flex: 1;">
                            <button class="action-btn btn-generate" id="generateRoomBtn" title="Generate Pokemon location room">üé≤</button>
                        </div>
                        <button class="action-btn btn-join" id="joinRoomBtn">Join Room</button>
                    </div>
                    <div class="room-options">
                        <label class="irc-checkbox">
                            <input type="checkbox" id="spectatorMode">
                            <span>Spectator Mode</span>
                            </label>
                        <label class="irc-checkbox">
                            <input type="checkbox" id="coachingMode">
                            <span>Coaching Mode</span>
                            </label>
                        </div>
                    <div class="room-info" id="roomInfo" style="display: none;">
                        <div class="room-header">
                            <div class="room-details">
                                <div class="room-name" id="roomTitle">Room: </div>
                                <div class="room-link" id="roomLink">Share: </div>
                            </div>
                            <div class="room-actions">
                                <button class="action-btn" id="copyRoomBtn" title="Copy Room ID">üìã Copy ID</button>
                                <button class="action-btn" id="copyLinkBtn" title="Copy Room Link">üîó Copy Link</button>
                                <button class="action-btn btn-leave" id="leaveRoomBtn">üö™ Leave</button>
                            </div>
                        </div>
                        <div class="player-list" id="playerList"></div>
                        <div class="connection-status-bar">
                            <span class="status-indicator" id="connectionIndicator">üî¥ Disconnected</span>
                            <span class="player-count" id="connectedPlayers">0 players</span>
                        </div>
                    </div>
                        </div>
                    </div>
                    
            <!-- System Channel -->
            <div class="irc-channel" id="systemChannel">
                <div class="irc-messages" id="systemMessages">
                    <div class="irc-message system">
                        <span class="timestamp">[00:00]</span>
                        <span class="nick">*</span>
                        <span class="message">Welcome to #system - Connection status and room notifications</span>
                    </div>
                    <div class="irc-message system">
                        <span class="timestamp">[00:00]</span>
                        <span class="nick">*</span>
                        <span class="message">üîó Room joining/leaving notifications appear here</span>
                    </div>
                    <div class="irc-message system">
                        <span class="timestamp">[00:00]</span>
                        <span class="nick">*</span>
                        <span class="message">‚öôÔ∏è System status and connection info</span>
                            </div>
                        </div>
                    </div>
                    </div>
                    
        <!-- IRC Input Area -->
        <div class="irc-input-area">
            <div class="irc-input-container">
                <input type="text" class="irc-message-input" id="ircMessageInput" placeholder="Type a message..." autocomplete="off">
                <button class="irc-send-btn" id="ircSendBtn">Send</button>
                    </div>
            <div class="irc-status-bar">
                <span class="user-info" id="userInfo">Guest</span>
                <span class="channel-info" id="channelInfo">#battle</span>
                <span class="user-count" id="userCount">1 user</span>
                <div class="chat-export-controls">
                    <button class="export-btn" id="exportChatMainBtn" title="Export Chat Log">üìÑ</button>
                    <button class="export-btn" id="copyChatMainBtn" title="Copy Chat Log">üìã</button>
                    <button class="export-btn" id="clearChatMainBtn" title="Clear Chat">üóëÔ∏è</button>
                </div>
                </div>
            </div>

        <!-- Resize Handles -->
        <div class="resize-handle resize-n" data-direction="n"></div>
        <div class="resize-handle resize-s" data-direction="s"></div>
        <div class="resize-handle resize-e" data-direction="e"></div>
        <div class="resize-handle resize-w" data-direction="w"></div>
        <div class="resize-handle resize-ne" data-direction="ne"></div>
        <div class="resize-handle resize-nw" data-direction="nw"></div>
        <div class="resize-handle resize-se" data-direction="se"></div>
        <div class="resize-handle resize-sw" data-direction="sw"></div>
                        </div>

    <!-- Minimized Chat Tab -->
    <div class="irc-minimized-tab" id="ircMinimizedTab" style="display: none;">
        <div class="minimized-header">
            <span class="minimized-icon">üí¨</span>
            <span class="minimized-text">Chat</span>
            <span class="minimized-unread" id="minimizedUnread">0</span>
        </div>
        <div class="minimized-messages" id="minimizedMessages">
            <!-- Recent messages will be shown here -->
        </div>
    </div>

    <!-- Chat Sidebar (when closed) -->
    <div class="chat-sidebar" id="chatSidebar">
        <div class="sidebar-header">
            <span>üí¨ Chat Log</span>
            <button class="irc-btn" id="openChatBtn" title="Open Chat">‚Üó</button>
            </div>
        <div class="sidebar-content" id="sidebarContent">
            <!-- Recent messages will be displayed here -->
            </div>
        <div class="sidebar-controls">
            <button class="sidebar-btn" id="exportChatBtn" title="Export Chat">üìÑ Export</button>
            <button class="sidebar-btn" id="copyChatBtn" title="Copy Chat">üìã Copy</button>
            <button class="sidebar-btn" id="clearSidebarBtn" title="Clear">üóëÔ∏è Clear</button>
        </div>
    </div>

    <script>
        // Pokemon data for room generation and usernames
        const POKEMON_LOCATIONS = [
            'Pallet Town', 'Viridian City', 'Pewter City', 'Cerulean City', 'Vermilion City',
            'Lavender Town', 'Celadon City', 'Fuchsia City', 'Saffron City', 'Cinnabar Island',
            'New Bark Town', 'Cherrygrove City', 'Violet City', 'Azalea Town', 'Goldenrod City',
            'Ecruteak City', 'Olivine City', 'Cianwood City', 'Mahogany Town', 'Blackthorn City',
            'Littleroot Town', 'Oldale Town', 'Petalburg City', 'Rustboro City', 'Dewford Town',
            'Slateport City', 'Mauville City', 'Verdanturf Town', 'Fallarbor Town', 'Fortree City',
            'Twinleaf Town', 'Sandgem Town', 'Jubilife City', 'Oreburgh City', 'Floaroma Town',
            'Eterna City', 'Hearthome City', 'Solaceon Town', 'Veilstone City', 'Pastoria City',
            'Nuvema Town', 'Accumula Town', 'Striaton City', 'Nacrene City', 'Castelia City',
            'Nimbasa City', 'Driftveil City', 'Mistralton City', 'Icirrus City', 'Opelucid City',
            'Vaniville Town', 'Aquacorde Town', 'Santalune City', 'Lumiose City', 'Camphrier Town',
            'Laverre City', 'Dendemille Town', 'Anistar City', 'Couriway Town', 'Snowbelle City',
            'Iki Town', 'Hau\'oli City', 'Heahea City', 'Konikoni City', 'Malie City',
            'Postwick', 'Wedgehurst', 'Turffield', 'Hulbury', 'Motostoke', 'Hammerlocke',
            'Wyndon', 'Circhester', 'Stow-on-Side', 'Ballonlea', 'Mt Moon', 'Victory Road',
            'Meteor Falls', 'Sky Pillar', 'Lake Verity', 'Lake Valor', 'Lake Acuity'
        ];

        const POKEMON_TRAINERS = [
            'Red', 'Ash', 'Leaf', 'Ethan', 'Lyra', 'Brendan', 'May', 'Lucas', 'Dawn',
            'Hilbert', 'Hilda', 'Nate', 'Rosa', 'Calem', 'Serena', 'Elio', 'Selene',
            'Victor', 'Gloria', 'Blue', 'Silver', 'Barry', 'Hugh', 'Cheren', 'Bianca',
            'Brock', 'Misty', 'Lt Surge', 'Erika', 'Koga', 'Sabrina', 'Blaine',
            'Falkner', 'Bugsy', 'Whitney', 'Morty', 'Chuck', 'Jasmine', 'Pryce', 'Clair',
            'Roxanne', 'Brawly', 'Wattson', 'Flannery', 'Norman', 'Winona', 'Tate', 'Liza',
            'Lance', 'Karen', 'Will', 'Bruno', 'Steven', 'Sidney', 'Phoebe', 'Glacia',
            'Aaron', 'Bertha', 'Flint', 'Lucian', 'Cynthia', 'Alder', 'Diantha', 'Leon',
            'Giovanni', 'Archie', 'Maxie', 'Cyrus', 'Ghetsis', 'Lysandre', 'Guzma',
            'Oak', 'Elm', 'Birch', 'Rowan', 'Juniper', 'Sycamore', 'Kukui', 'Magnolia',
            'Gary', 'Tobias', 'Virgil', 'Sawyer', 'Conway', 'Harrison', 'Ritchie',
            'Wally', 'Hau', 'Hop', 'Bede', 'Marnie', 'Gladion', 'Trace', 'Paul'
        ];

        class IRCChatInterface {
            constructor() {
                this.isMinimized = false;
                this.isMaximized = false;
                this.isDragging = false;
                this.isResizing = false;
                this.currentChannel = 'battle';
                this.unreadCounts = { battle: 0, multiplayer: 0, system: 0 };
                this.username = 'Guest';
                this.roomId = null;
                this.isConnected = false;
                this.roomJoinedProcessed = false;
                
                this.initializeElements();
                this.initializeEventListeners();
                this.loadSavedState();
                this.setupResizing();
                this.setupDragging();
                this.initializePokemonDefaults();
                this.checkUrlForRoom();
            }

            initializeElements() {
                this.chatWindow = document.getElementById('ircChatWindow');
                this.titleBar = document.getElementById('ircTitleBar');
                this.minimizedTab = document.getElementById('ircMinimizedTab');
                this.messageInput = document.getElementById('ircMessageInput');
                this.chatSidebar = document.getElementById('chatSidebar');
                this.sidebarContent = document.getElementById('sidebarContent');
                this.channels = {
                    battle: document.getElementById('battleChannel'),
                    multiplayer: document.getElementById('multiplayerChannel'),
                    system: document.getElementById('systemChannel')
                };
                this.tabs = {
                    battle: document.getElementById('battleTab'),
                    multiplayer: document.getElementById('multiplayerTab'),
                    system: document.getElementById('systemTab')
                };
                this.messages = {
                    battle: document.getElementById('battleMessages'),
                    multiplayer: document.getElementById('multiplayerMessages'),
                    system: document.getElementById('systemMessages')
                };
                this.allMessages = []; // Store all messages for export/sidebar
            }

            initializeEventListeners() {
                // Window controls
                document.getElementById('minimizeBtn').addEventListener('click', () => this.minimize());
                document.getElementById('maximizeBtn').addEventListener('click', () => this.toggleMaximize());
                document.getElementById('closeBtn').addEventListener('click', () => this.close());
                
                // Minimized tab
                this.minimizedTab.addEventListener('click', () => this.restore());
                
                // Room sharing controls (title bar)
                document.getElementById('roomShareBtn').addEventListener('click', () => this.copyRoomIdFromTitleBar());
                document.getElementById('roomLinkBtn').addEventListener('click', () => this.copyRoomLinkFromTitleBar());
                
                // Sidebar controls
                document.getElementById('openChatBtn').addEventListener('click', () => this.openFromSidebar());
                document.getElementById('exportChatBtn').addEventListener('click', () => this.exportChat());
                document.getElementById('copyChatBtn').addEventListener('click', () => this.copyChat());
                document.getElementById('clearSidebarBtn').addEventListener('click', () => this.clearSidebar());
                
                // Main export controls
                document.getElementById('exportChatMainBtn').addEventListener('click', () => this.exportChat());
                document.getElementById('copyChatMainBtn').addEventListener('click', () => this.copyChat());
                document.getElementById('clearChatMainBtn').addEventListener('click', () => this.clearAllMessages());
                
                // Channel tabs
                Object.keys(this.tabs).forEach(channel => {
                    this.tabs[channel].addEventListener('click', () => this.switchChannel(channel));
                });
                
                // Message input
                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });
                document.getElementById('ircSendBtn').addEventListener('click', () => this.sendMessage());

                // Action buttons
                document.getElementById('ircAttackBtn').addEventListener('click', () => this.sendAction('attack'));
                document.getElementById('ircPassBtn').addEventListener('click', () => this.sendAction('pass'));
                document.getElementById('ircUndoBtn').addEventListener('click', () => this.sendAction('undo'));
                document.getElementById('ircCoinBtn').addEventListener('click', () => this.sendAction('coin'));
                
                // Emoji buttons
                document.querySelectorAll('.emoji-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const emoji = btn.getAttribute('data-emoji');
                        this.sendEmoji(emoji);
                    });
                });
                
                // Multiplayer controls
                document.getElementById('joinRoomBtn').addEventListener('click', () => this.joinRoom());
                document.getElementById('generateRoomBtn').addEventListener('click', () => this.generateRoomId());
                document.getElementById('generateTrainerBtn').addEventListener('click', () => this.generateTrainerName());
                document.getElementById('copyRoomBtn').addEventListener('click', () => this.copyRoomId());
                document.getElementById('copyLinkBtn').addEventListener('click', () => this.copyRoomLink());
                document.getElementById('leaveRoomBtn').addEventListener('click', () => this.leaveRoom());
            }

            setupDragging() {
                // Dragging disabled - chat window is fixed in position
            }

            setupResizing() {
                // Resizing disabled - chat window has fixed size
            }

            switchChannel(channel) {
                // Update active channel
                this.currentChannel = channel;
                
                // Update tabs
                Object.keys(this.tabs).forEach(ch => {
                    this.tabs[ch].classList.toggle('active', ch === channel);
                });
                
                // Update channels
                Object.keys(this.channels).forEach(ch => {
                    this.channels[ch].classList.toggle('active', ch === channel);
                });
                
                // Clear unread count for active channel
                this.unreadCounts[channel] = 0;
                this.updateUnreadDisplay();
                
                // Update status bar
                document.getElementById('channelInfo').textContent = '#' + channel;
                
                // Focus input
                this.messageInput.focus();
            }

            addMessage(channel, type, nick, message, timestamp = null, fromGame = false) {
                if (!this.messages[channel]) return;
                
                const time = timestamp || new Date();
                const timeStr = time.toLocaleTimeString('en-US', { 
                    hour12: false, 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                // Enhanced duplicate prevention
                const messageKey = `${channel}-${type}-${nick}-${message}-${timeStr}`;
                if (this.lastMessageKey === messageKey) {
                    console.log('Duplicate message prevented:', messageKey);
                    return;
                }
                this.lastMessageKey = messageKey;
                
                // Debug: Check what we're storing
                console.log('Adding message:', { channel, type, nick, message, fromGame });
                
                // Store message for export/sidebar (avoid duplicates from game)
                if (!fromGame || type !== 'game') {
                    this.allMessages.push({
                        channel,
                        type,
                        nick,
                        message: String(message || ''), // Ensure it's a string
                        time: timeStr,
                        timestamp: time
                    });
                }
                
                const messageEl = document.createElement('div');
                messageEl.className = `irc-message ${type}`;
                
                // Add special styling for different message types
                if (type === 'emoji') {
                    messageEl.classList.add('emoji-message');
                } else if (type === 'system' || type === 'announcement') {
                    messageEl.classList.add('system-message');
                } else if (type === 'game-action') {
                    messageEl.classList.add('action-message');
                }
                
                messageEl.innerHTML = `
                    <span class="timestamp">[${timeStr}]</span>
                    <span class="nick">${nick}</span>
                    <span class="message">${message}</span>
                `;
                
                this.messages[channel].appendChild(messageEl);
                this.messages[channel].scrollTop = this.messages[channel].scrollHeight;
                
                // Add animation for new messages
                messageEl.style.opacity = '0';
                messageEl.style.transform = 'translateX(-10px)';
                setTimeout(() => {
                    messageEl.style.transition = 'all 0.3s ease';
                    messageEl.style.opacity = '1';
                    messageEl.style.transform = 'translateX(0)';
                }, 10);
                
                // Update sidebar if it's open
                if (this.chatSidebar.classList.contains('show')) {
                    this.updateSidebarContent();
                }
                
                // Update minimized tab if minimized
                if (this.isMinimized) {
                    this.updateMinimizedContent();
                }
                
                // Update unread count if not active channel
                if (channel !== this.currentChannel) {
                    this.unreadCounts[channel]++;
                    this.updateUnreadDisplay();
                    
                    // Add visual notification for new messages
                    const tab = this.tabs[channel];
                    if (tab) {
                        tab.classList.add('has-unread');
                        setTimeout(() => {
                            tab.classList.remove('has-unread');
                        }, 3000);
                    }
                }
            }

            sendMessage() {
                const message = this.messageInput.value.trim();
                if (!message) return;
                
                // Handle IRC commands
                if (message.startsWith('/')) {
                    this.handleCommand(message);
                } else {
                    // For multiplayer channel, send directly to other players via socket
                    if (this.currentChannel === 'multiplayer' && this.roomId) {
                        // Send to parent window for socket transmission
                        window.parent.postMessage({
                            type: 'multiplayerMessage',
                            data: { 
                                message, 
                                username: this.username,
                                roomId: this.roomId
                            }
                        }, '*');
                        
                        // Add locally as self message
                        this.addMessage('multiplayer', 'self', this.username, message);
                    } else {
                        // For battle/system channels, send to parent window for integration
                        window.parent.postMessage({
                            type: 'chatMessage',
                            data: { 
                                channel: this.currentChannel, 
                                message, 
                                username: this.username,
                                messageType: 'message'
                            }
                        }, '*');
                    }
                }
                
                this.messageInput.value = '';
            }

            sendAction(action) {
                // Don't add message here - let the parent window handle the action and send back the result
                // This prevents duplicate messages
                
                // Send to parent window
                window.parent.postMessage({
                    type: 'playerAction',
                    data: { action, username: this.username }
                }, '*');
            }

            sendEmoji(emoji) {
                // Send emoji as a special message type
                window.parent.postMessage({
                    type: 'chatMessage',
                    data: { 
                        channel: this.currentChannel, 
                        message: emoji, 
                        username: this.username,
                        messageType: 'emoji'
                    }
                }, '*');
            }

            handleCommand(command) {
                const parts = command.split(' ');
                const cmd = parts[0].toLowerCase();
                
                switch (cmd) {
                    case '/nick':
                        if (parts[1]) {
                            const oldNick = this.username;
                            this.username = parts[1];
                            this.addMessage(this.currentChannel, 'system', '*', `${oldNick} is now known as ${this.username}`);
                            document.getElementById('userInfo').textContent = this.username;
                        }
                        break;
                    case '/join':
                        if (parts[1]) {
                            const channel = parts[1].replace('#', '');
                            if (this.channels[channel]) {
                                this.switchChannel(channel);
                            }
                        }
                        break;
                    case '/clear':
                        this.messages[this.currentChannel].innerHTML = '';
                        break;
                    case '/help':
                        this.showHelp();
                        break;
                    default:
                        this.addMessage(this.currentChannel, 'error', '*', `Unknown command: ${cmd}`);
                }
            }

            showHelp() {
                const helpText = `
                    Available commands:
                    /nick <name> - Change your nickname
                    /join <channel> - Switch to a channel
                    /clear - Clear current channel
                    /help - Show this help
                `;
                this.addMessage(this.currentChannel, 'system', '*', helpText);
            }

            minimize() {
                this.isMinimized = true;
                this.chatWindow.style.display = 'none';
                this.minimizedTab.style.display = 'flex';
                this.updateMinimizedContent();
                this.saveState();
            }

            restore() {
                this.isMinimized = false;
                this.chatWindow.style.display = 'flex';
                this.minimizedTab.style.display = 'none';
                this.messageInput.focus();
                this.saveState();
            }

                        toggleMaximize() {
                this.isMaximized = !this.isMaximized;
                
                if (this.isMaximized) {
                    this.chatWindow.style.left = '0px';
                    this.chatWindow.style.bottom = '0px';
                    this.chatWindow.style.width = '100vw';
                    this.chatWindow.style.height = '100vh';
                } else {
                    this.loadSavedState();
                }

                this.saveState();
            }

            close() {
                this.chatWindow.style.display = 'none';
                this.minimizedTab.style.display = 'none';
                
                // Show sidebar instead of completely closing
                this.showSidebar();
                
                // Notify parent window
                window.parent.postMessage({
                    type: 'chatClosed'
                }, '*');
            }

            showSidebar() {
                this.chatSidebar.classList.add('show');
                document.body.classList.add('sidebar-open');
                this.updateSidebarContent();
                
                // Notify parent window to adjust layout
                window.parent.postMessage({
                    type: 'sidebarOpened'
                }, '*');
            }

            hideSidebar() {
                this.chatSidebar.classList.remove('show');
                document.body.classList.remove('sidebar-open');
                
                // Notify parent window to restore layout
                window.parent.postMessage({
                    type: 'sidebarClosed'
                }, '*');
            }

            openFromSidebar() {
                this.hideSidebar();
                this.restore();
            }

            updateSidebarContent() {
                // Show recent messages from all channels in sidebar
                const recentMessages = this.allMessages.slice(-20); // Last 20 messages
                this.sidebarContent.innerHTML = '';
                
                recentMessages.forEach(msg => {
                    const msgEl = document.createElement('div');
                    msgEl.className = `sidebar-message ${msg.type}`;
                    
                    // Create properly structured message that uses full width
                    const timeText = `[${msg.time}]`;
                    const channelText = `#${msg.channel}`;
                    const nickText = `${msg.nick}:`;
                    const messageText = String(msg.message || '');
                    
                    // Create the full message text in one line for natural wrapping
                    const fullText = `${timeText} ${channelText} ${nickText} ${messageText}`;
                    msgEl.textContent = fullText;
                    
                    this.sidebarContent.appendChild(msgEl);
                });
                
                this.sidebarContent.scrollTop = this.sidebarContent.scrollHeight;
            }

            exportChat() {
                const chatLog = this.allMessages.map(msg => 
                    `[${msg.time}] #${msg.channel} ${msg.nick}: ${msg.message}`
                ).join('\n');
                
                const blob = new Blob([chatLog], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ptcg-chat-${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            copyChat() {
                const chatLog = this.allMessages.map(msg => 
                    `[${msg.time}] #${msg.channel} ${msg.nick}: ${msg.message}`
                ).join('\n');
                
                navigator.clipboard.writeText(chatLog).then(() => {
                    // Show temporary feedback
                    const btn = document.getElementById('copyChatBtn');
                    const originalText = btn.textContent;
                    btn.textContent = '‚úì Copied!';
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy chat:', err);
                });
            }

            clearSidebar() {
                this.allMessages = [];
                this.sidebarContent.innerHTML = '<div class="sidebar-message system">Chat cleared</div>';
            }

            clearAllMessages() {
                // Clear all messages from all channels
                Object.keys(this.messages).forEach(channel => {
                    this.messages[channel].innerHTML = `
                        <div class="irc-message system">
                            <span class="timestamp">[${new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' })}]</span>
                            <span class="nick">*</span>
                            <span class="message">Chat cleared</span>
                        </div>
                    `;
                });
                
                // Clear stored messages
                this.allMessages = [];
                
                // Clear sidebar
                this.updateSidebarContent();
                
                // Clear minimized content
                this.updateMinimizedContent();
                
                // Reset unread counts
                this.unreadCounts = { battle: 0, multiplayer: 0, system: 0 };
                this.updateUnreadDisplay();
            }

            updateMinimizedContent() {
                const minimizedMessages = document.getElementById('minimizedMessages');
                if (!minimizedMessages) return;
                
                // Show last 3 messages in minimized tab
                const recentMessages = this.allMessages.slice(-3);
                minimizedMessages.innerHTML = '';
                
                recentMessages.forEach((msg, index) => {
                    // Debug: Check message content
                    console.log('Minimized message:', msg);
                    
                    const msgEl = document.createElement('div');
                    msgEl.className = `minimized-message ${msg.type} ${index === recentMessages.length - 1 ? 'recent' : ''}`;
                    
                    const timeSpan = document.createElement('span');
                    timeSpan.className = 'minimized-time';
                    timeSpan.textContent = `[${msg.time}] `;
                    
                    const nickSpan = document.createElement('span');
                    nickSpan.className = 'minimized-nick';
                    nickSpan.textContent = `${msg.nick}: `;
                    
                    const textSpan = document.createElement('span');
                    textSpan.className = 'minimized-text-content';
                    // Don't truncate - let CSS handle wrapping
                    const messageText = String(msg.message || '');
                    textSpan.textContent = messageText;
                    
                    msgEl.appendChild(timeSpan);
                    msgEl.appendChild(nickSpan);
                    msgEl.appendChild(textSpan);
                    
                    minimizedMessages.appendChild(msgEl);
                });
                
                minimizedMessages.scrollTop = minimizedMessages.scrollHeight;
            }

            updateUnreadDisplay() {
                Object.keys(this.unreadCounts).forEach(channel => {
                    const count = this.unreadCounts[channel];
                    const unreadEl = document.getElementById(channel + 'Unread');
                    if (unreadEl) {
                        unreadEl.textContent = count;
                        unreadEl.style.display = count > 0 ? 'inline' : 'none';
                    }
                });
                
                const totalUnread = Object.values(this.unreadCounts).reduce((a, b) => a + b, 0);
                const minimizedUnread = document.getElementById('minimizedUnread');
                if (minimizedUnread) {
                    minimizedUnread.textContent = totalUnread;
                    minimizedUnread.style.display = totalUnread > 0 ? 'inline' : 'none';
                }
            }

            joinRoom() {
                let playerName = document.getElementById('playerNameInput').value.trim();
                let roomId = document.getElementById('roomIdInput').value.trim();
                
                // If no name provided, use a random Pokemon trainer name
                if (!playerName) {
                    playerName = this.generateRandomTrainerName();
                    document.getElementById('playerNameInput').value = playerName;
                    this.addMessage('system', 'system', '*', `Auto-assigned trainer name: ${playerName}`);
                }
                
                // If no room ID provided, generate one automatically
                if (!roomId) {
                    const location = POKEMON_LOCATIONS[Math.floor(Math.random() * POKEMON_LOCATIONS.length)];
                    const numbers = Math.floor(Math.random() * 999) + 1;
                    roomId = location.replace(/\s+/g, '') + numbers;
                    document.getElementById('roomIdInput').value = roomId;
                    this.addMessage('system', 'system', '*', `Auto-generated room: ${roomId} (${location})`);
                }
                
                this.username = playerName;
                this.roomId = roomId;
                
                // Update URL to include room parameter for easy sharing
                const baseUrl = window.parent.location.origin + window.parent.location.pathname;
                const newUrl = `${baseUrl}?room=${encodeURIComponent(roomId)}`;
                window.parent.history.replaceState({}, '', newUrl);
                
                // Switch to multiplayer channel when joining
                this.switchChannel('multiplayer');
                
                // Hide join controls and show room info
                document.getElementById('multiplayerControls').style.display = 'none';
                document.getElementById('roomInfo').style.display = 'block';
                document.getElementById('roomTitle').textContent = `Room: ${roomId}`;
                
                // Update room link display
                document.getElementById('roomLink').textContent = `Share: ${newUrl}`;
                
                // Send to parent window
                window.parent.postMessage({
                    type: 'joinRoom',
                    data: {
                        playerName,
                        roomId,
                        isSpectator: document.getElementById('spectatorMode').checked,
                        coachingMode: document.getElementById('coachingMode').checked
                    }
                }, '*');
                
                this.addMessage('system', 'system', '*', `Joining room ${roomId} as ${playerName}...`);
                this.addMessage('multiplayer', 'system', '*', `Room URL updated! You can now share: ${newUrl}`);
            }

            generateRoomId() {
                // Generate Pokemon location-based room ID with trailing numbers
                const location = POKEMON_LOCATIONS[Math.floor(Math.random() * POKEMON_LOCATIONS.length)];
                const numbers = Math.floor(Math.random() * 999) + 1; // 1-999
                const roomId = location.replace(/\s+/g, '') + numbers; // Remove spaces and add numbers
                document.getElementById('roomIdInput').value = roomId;
                
                this.addMessage('multiplayer', 'system', '*', `Generated room: ${roomId} (${location})`);
            }

            generateRandomTrainerName() {
                // Generate random Pokemon trainer name
                const trainer = POKEMON_TRAINERS[Math.floor(Math.random() * POKEMON_TRAINERS.length)];
                return trainer;
            }

            generateTrainerName() {
                // Generate and set a random Pokemon trainer name
                const trainerName = this.generateRandomTrainerName();
                document.getElementById('playerNameInput').value = trainerName;
                this.addMessage('multiplayer', 'system', '*', `Generated trainer: ${trainerName}`);
            }

            copyRoomId() {
                if (this.roomId) {
                    navigator.clipboard.writeText(this.roomId).then(() => {
                        // Show temporary feedback
                        const btn = document.getElementById('copyRoomBtn');
                        const originalText = btn.textContent;
                        btn.textContent = '‚úì Copied';
                        btn.style.background = 'rgba(100, 180, 100, 0.8)';
                        
                        setTimeout(() => {
                            btn.textContent = originalText;
                            btn.style.background = '';
                        }, 1500);
                        
                        this.addMessage('multiplayer', 'system', '*', `Room ID copied to clipboard: ${this.roomId}`);
                    }).catch(err => {
                        console.error('Failed to copy room ID:', err);
                        this.addMessage('multiplayer', 'error', '*', 'Failed to copy room ID to clipboard');
                    });
                }
            }

            copyRoomLink() {
                if (this.roomId) {
                    // Get the current URL without query parameters
                    const baseUrl = window.parent.location.origin + window.parent.location.pathname;
                    const roomLink = `${baseUrl}?room=${encodeURIComponent(this.roomId)}`;
                    
                    navigator.clipboard.writeText(roomLink).then(() => {
                        // Show temporary feedback
                        const btn = document.getElementById('copyLinkBtn');
                        const originalText = btn.textContent;
                        btn.textContent = '‚úì Copied';
                        btn.style.background = 'rgba(100, 180, 100, 0.8)';
                        
                        setTimeout(() => {
                            btn.textContent = originalText;
                            btn.style.background = '';
                        }, 1500);
                        
                        // Update room link display
                        document.getElementById('roomLink').textContent = `Share: ${roomLink}`;
                        
                        this.addMessage('multiplayer', 'system', '*', `Room link copied to clipboard! Share with friends to join directly.`);
                    }).catch(err => {
                        console.error('Failed to copy room link:', err);
                        this.addMessage('multiplayer', 'error', '*', 'Failed to copy room link to clipboard');
                    });
                }
            }

            initializePokemonDefaults() {
                // Set default trainer name placeholder
                const nameInput = document.getElementById('playerNameInput');
                if (nameInput && !nameInput.value.trim()) {
                    const defaultName = this.generateRandomTrainerName();
                    nameInput.placeholder = `e.g., ${defaultName}`;
                }
                
                // Set room ID placeholder with example
                const roomInput = document.getElementById('roomIdInput');
                if (roomInput && !roomInput.value.trim()) {
                    const exampleLocation = POKEMON_LOCATIONS[Math.floor(Math.random() * POKEMON_LOCATIONS.length)];
                    const exampleNumbers = Math.floor(Math.random() * 999) + 1;
                    roomInput.placeholder = `e.g., ${exampleLocation.replace(/\s+/g, '')}${exampleNumbers}`;
                }
            }

            checkUrlForRoom() {
                // Check if there's a room parameter in the parent window URL
                const urlParams = new URLSearchParams(window.parent.location.search);
                const roomFromUrl = urlParams.get('room');
                
                if (roomFromUrl) {
                    // Show room invitation prompt (step 1)
                    this.showRoomInvitationPrompt(roomFromUrl);
                }
            }

            showRoomInvitationPrompt(roomId) {
                // Remove any existing modals first
                this.closeInvitationModal();
                
                // Send modal data to parent window to create it on the main screen
                window.parent.postMessage({
                    type: 'showRoomInvitationModal',
                    data: { roomId }
                }, '*');
            }

            showRoomJoinForm(roomId, isSpectator) {
                // Send join form data to parent window to create it on the main screen
                window.parent.postMessage({
                    type: 'showRoomJoinForm',
                    data: { 
                        roomId, 
                        isSpectator,
                        defaultName: this.generateRandomTrainerName()
                    }
                }, '*');
            }

            closeInvitationModal() {
                // Send close modal message to parent window
                window.parent.postMessage({
                    type: 'closeRoomModal'
                }, '*');
            }

            joinRoomFromPrompt(roomId, playerName, isSpectator, coachingMode) {
                // Remove the modal
                this.closeInvitationModal();
                
                // Set the values in the interface
                const playerNameInput = document.getElementById('playerNameInput');
                const roomIdInput = document.getElementById('roomIdInput');
                const spectatorCheckbox = document.getElementById('spectatorMode');
                const coachingCheckbox = document.getElementById('coachingMode');
                
                if (playerNameInput) playerNameInput.value = playerName;
                if (roomIdInput) roomIdInput.value = roomId;
                if (spectatorCheckbox) spectatorCheckbox.checked = isSpectator;
                if (coachingCheckbox) coachingCheckbox.checked = coachingMode;

                this.username = playerName;
                this.roomId = roomId;

                // Switch to multiplayer channel
                this.switchChannel('multiplayer');

                // Hide join controls and show room info
                document.getElementById('multiplayerControls').style.display = 'none';
                document.getElementById('roomInfo').style.display = 'block';
                document.getElementById('roomTitle').textContent = `Room: ${roomId}`;

                // Send to parent window
                window.parent.postMessage({
                    type: 'joinRoom',
                    data: {
                        playerName,
                        roomId,
                        isSpectator,
                        coachingMode
                    }
                }, '*');

                this.addMessage('system', 'system', '*', `Joining room ${roomId} as ${playerName}...`);
            }

            leaveRoom() {
                if (this.roomId) {
                    window.parent.postMessage({
                        type: 'leaveRoom'
                    }, '*');
                    
                    this.addMessage('multiplayer', 'system', '*', `Left room ${this.roomId}`);
                    this.roomId = null;
                    this.roomJoinedProcessed = false;
                    
                    // Clear URL parameters
                    const newUrl = window.parent.location.origin + window.parent.location.pathname;
                    window.parent.history.replaceState({}, '', newUrl);
                    
                    // Show join controls and hide room info
                    document.getElementById('multiplayerControls').style.display = 'block';
                    document.getElementById('roomInfo').style.display = 'none';
                    
                    // Hide room sharing box in title bar
                    this.updateRoomSharingBox(null);
                    
                    // Clear the input fields
                    document.getElementById('playerNameInput').value = '';
                    document.getElementById('roomIdInput').value = '';
                    
                    // Reset placeholders
                    this.initializePokemonDefaults();
                }
            }

            updateRoomSharingBox(roomId) {
                const roomSharingBox = document.getElementById('roomSharingBox');
                const roomShareId = document.getElementById('roomShareId');
                
                if (roomId) {
                    // Show room sharing box and update room ID
                    roomSharingBox.style.display = 'flex';
                    roomShareId.textContent = roomId;
                    this.roomId = roomId;
                } else {
                    // Hide room sharing box
                    roomSharingBox.style.display = 'none';
                    roomShareId.textContent = '-';
                    this.roomId = null;
                }
            }

            // Title bar room sharing button handlers
            copyRoomIdFromTitleBar() {
                if (this.roomId) {
                    navigator.clipboard.writeText(this.roomId).then(() => {
                        // Show temporary feedback
                        const btn = document.getElementById('roomShareBtn');
                        const originalText = btn.innerHTML;
                        btn.innerHTML = '‚úì';
                        btn.style.background = 'rgba(0, 255, 0, 0.3)';
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                            btn.style.background = '';
                        }, 2000);
                        
                        this.addMessage('system', 'system', '*', `Room ID copied: ${this.roomId}`);
                    }).catch(err => {
                        console.error('Failed to copy room ID:', err);
                    });
                }
            }

            copyRoomLinkFromTitleBar() {
                if (this.roomId) {
                    const baseUrl = window.parent.location.origin + window.parent.location.pathname;
                    const roomLink = `${baseUrl}?room=${encodeURIComponent(this.roomId)}`;
                    
                    navigator.clipboard.writeText(roomLink).then(() => {
                        // Show temporary feedback
                        const btn = document.getElementById('roomLinkBtn');
                        const originalText = btn.innerHTML;
                        btn.innerHTML = '‚úì';
                        btn.style.background = 'rgba(0, 255, 0, 0.3)';
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                            btn.style.background = '';
                        }, 2000);
                        
                        this.addMessage('system', 'system', '*', `Room link copied! Share with friends to join directly.`);
                    }).catch(err => {
                        console.error('Failed to copy room link:', err);
                    });
                }
            }

            // Handle messages from parent window
            receiveMessage(type, data) {
                console.log('IRC Chat received message:', type, data);
                switch (type) {
                    case 'gameMessage':
                        // Route game messages to battle channel
                        this.addMessage('battle', data.type || 'game', data.username || 'Game', data.message, null, true);
                        break;
                    case 'joinRoomFromModal':
                        // Handle room joining from main window modal
                        this.joinRoomFromPrompt(data.roomId, data.playerName, data.isSpectator, data.coachingMode);
                        break;
                    case 'newMessage':
                        // Handle new message format from the game - only if not already processed
                        if (!data.processed) {
                            // Enhanced message routing logic
                            let channel = 'battle'; // Default to battle
                            let messageType = data.type || 'system';
                            const username = data.username || 'Game';
                            const message = data.content || data.message || '';
                            
                            // Route messages based on content and type
                            if (data.tab) {
                                channel = data.tab; // Use specified tab if provided
                            } else {
                                // Auto-route based on message content and type
                                if (messageType === 'self' || messageType === 'opp') {
                                    // Player messages go to multiplayer if in multiplayer mode
                                    channel = this.roomId ? 'multiplayer' : 'battle';
                                } else if (message.includes('joined') || message.includes('left') || 
                                          message.includes('room') || message.includes('connected') ||
                                          message.includes('disconnected')) {
                                    // Connection/room messages go to system
                                    channel = 'system';
                                    messageType = 'system';
                                } else if (messageType === 'announcement' || messageType === 'game-action') {
                                    // Game actions stay in battle
                                    channel = 'battle';
                                } else if (messageType === 'system') {
                                    // System messages go to system channel
                                    channel = 'system';
                                }
                            }
                            
                            this.addMessage(channel, messageType, username, message, null, true);
                            data.processed = true; // Mark as processed
                        }
                        break;
                    case 'playerMessage':
                        // Player-to-player messages always go to multiplayer
                        this.addMessage('multiplayer', 'opp', data.username, data.message);
                        break;
                    case 'systemMessage':
                        // System messages go to system channel
                        this.addMessage('system', 'system', 'System', data.message);
                        break;
                    case 'roomJoined':
                        // Only process once to prevent duplicate messages
                        if (!this.roomJoinedProcessed) {
                            this.addMessage('system', 'system', '*', `Successfully connected to room ${data.roomId}`);
                            this.addMessage('multiplayer', 'system', '*', `Welcome to room ${data.roomId}! You can now chat with other players.`);
                            this.roomJoinedProcessed = true;
                            
                            // Update room sharing box in title bar
                            this.updateRoomSharingBox(data.roomId);
                        }
                        // UI changes are already handled in joinRoom() function
                        break;
                    case 'playerJoined':
                        // Player join notifications go to both system and multiplayer
                        this.addMessage('system', 'system', '*', `${data.username} joined the room`);
                        this.addMessage('multiplayer', 'system', '*', `${data.username} joined the room`);
                        break;
                    case 'playerLeft':
                        // Player leave notifications go to both system and multiplayer
                        this.addMessage('system', 'system', '*', `${data.username} left the room`);
                        this.addMessage('multiplayer', 'system', '*', `${data.username} left the room`);
                        break;
                    case 'multiplayerMessage':
                        // Explicit multiplayer messages
                        this.addMessage('multiplayer', data.messageType || 'opp', data.username, data.message);
                        break;
                }
            }

            saveState() {
                const state = {
                    position: {
                        left: this.chatWindow.style.left,
                        bottom: this.chatWindow.style.bottom,
                        width: this.chatWindow.style.width,
                        height: this.chatWindow.style.height
                    },
                    isMinimized: this.isMinimized,
                    isMaximized: this.isMaximized,
                    currentChannel: this.currentChannel,
                    username: this.username
                };
                
                localStorage.setItem('ircChatState', JSON.stringify(state));
            }

            loadSavedState() {
                const saved = localStorage.getItem('ircChatState');
                if (saved) {
                    const state = JSON.parse(saved);
                    
                    if (state.position) {
                        this.chatWindow.style.left = state.position.left || '20px';
                        this.chatWindow.style.bottom = state.position.bottom || '20px';
                        this.chatWindow.style.width = state.position.width || '400px';
                        this.chatWindow.style.height = state.position.height || '300px';
                    }
                    
                    if (state.currentChannel) {
                        this.switchChannel(state.currentChannel);
                    }
                    
                    if (state.username) {
                        this.username = state.username;
                        document.getElementById('userInfo').textContent = this.username;
                    }
                    
                    if (state.isMinimized) {
                        this.minimize();
                    }
                }
            }
        }

        // Initialize IRC Chat Interface
        const ircChat = new IRCChatInterface();
        
        // Simple setup - chat is always interactive
        console.log('IRC Chat interface loaded and ready');
            
                    // Listen for messages from parent window
        window.addEventListener('message', (event) => {
            if (event.origin !== window.location.origin) return;
            
            // Filter out unwanted messages (like Metamask)
            if (!event.data || typeof event.data !== 'object') return;
            if (event.data.name === 'metamask-provider') return;
            
            const { type, data } = event.data;
            if (!type) return; // Ignore messages without a type
            
            // No special activation handling needed
            
            ircChat.receiveMessage(type, data);
        });

        // Make it available globally
        window.ircChat = ircChat;
    </script>
</body>
</html> 