<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PTCG Raid System Integration - Test Client</title>
    <style>
        /* Styles from your raid-test.html - condensed for brevity */
        body { margin: 0; padding: 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
        .raid-launcher { background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 30px; max-width: 600px; margin: 40px auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); backdrop-filter: blur(10px); }
        .raid-launcher h1 { text-align: center; color: #333; margin-bottom: 30px; font-size: 28px; }
        .button-group { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .raid-button { flex: 1 1 auto; min-width: 150px; padding: 15px 20px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 1px; }
        .create-raid { background: linear-gradient(45deg, #ff6b6b, #ee5a24); color: white; }
        .join-raid { background: linear-gradient(45deg, #4ecdc4, #44a08d); color: white; }
        .layout-toggle { background: linear-gradient(45deg, #a55eea, #8e44ad); color: white; }
        .raid-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); }
        .raid-button:disabled { opacity: 0.6; cursor: not-allowed; }
        .raid-input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 15px; box-sizing: border-box; }
        .raid-status { background: rgba(255, 255, 255, 0.8); color: #333; padding: 15px; border-radius: 8px; margin-top: 20px; min-height: 150px; font-family: monospace; font-size: 14px; white-space: pre-wrap; overflow-y: auto; max-height: 300px; border: 1px solid #eee; }
        #raidContainer { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: linear-gradient(45deg, #2c3e50 0%, #3498db 100%); display: none; z-index: 1000; perspective: 1000px; color: white; }
        #raidTable { position: absolute; top: 50%; left: 50%; width: 90vw; height: 90vh; background: radial-gradient(circle at center, rgba(255,255,255,0.05) 0%, transparent 40%), linear-gradient(45deg, #34495e 0%, #2c3e50 100%); border-radius: 20px; transform: translate(-50%, -50%) perspective(1000px) rotateX(10deg); box-shadow: 0 20px 60px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1); overflow: hidden; }
        .raid-player { position: absolute; width: 120px; height: 80px; border: 3px solid #fff; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); transition: all 0.3s ease; cursor: pointer; }
        .raid-player:hover { transform: translate(-50%, -50%) scale(1.1) !important; }
        .raid-player.current-player { border-color: #f1c40f; box-shadow: 0 5px 15px rgba(0,0,0,0.3), 0 0 20px rgba(241,196,15,0.6); }
        .raid-boss { position: absolute; width: 180px; height: 270px; background: radial-gradient(circle, #e74c3c 0%, #c0392b 100%); border: 3px solid #fff; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-size: 20px; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.7); transform: translate(-50%, -50%); animation: bossIdle 4s ease-in-out infinite; padding: 10px; box-sizing: border-box; }
        @keyframes bossIdle { 0%, 100% { transform: translate(-50%, -50%) translateY(0px) scale(1); } 50% { transform: translate(-50%, -50%) translateY(-5px) scale(1.02); } }
        .raid-controls { position: fixed; top: 20px; right: 20px; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px; color: white; z-index: 1001; display: none; }
        .control-button { background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; margin: 5px; transition: all 0.3s ease; }
        .control-button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .angle-indicator { position: absolute; top: -10px; right: -10px; width: 25px; height: 25px; background: rgba(255,255,255,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #333; font-weight: bold; }
        .versus-indicator { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 8px 15px; border-radius: 20px; font-size: 14px; z-index: 10; }
        .layout-versus { background: linear-gradient(45deg, #e74c3c 0%, #c0392b 100%); }
        .layout-circular { background: linear-gradient(45deg, #3498db 0%, #2980b9 100%); }
    </style>

    <script src="/socket.io/socket.io.js"></script>

    <!--
        EnhancedRaidClient.js will be imported as an ES Module in the script block below.
        Ensure your server correctly serves:
        - client/src/raid/EnhancedRaidClient.js
        - client/src/front-end.js (which EnhancedRaidClient imports for 'socket' and 'systemState')
        - client/src/initialization/global-variables/global-variables.js (which front-end.js imports for 'socket')
        - client/src/raid/components/RaidGameUI.js (and its dependencies like TurnIndicatorBar.js)
        All these files should be valid ES modules if they use import/export syntax.
    -->
</head>
<body>
    <iframe id="selfContainer" style="display: none; width:0; height:0;" title="dummy self container"></iframe>
    <iframe id="oppContainer" style="display: none; width:0; height:0;" title="dummy opp container"></iframe>

    <div class="raid-launcher">
        <h1>üè¥‚Äç‚ò†Ô∏è PTCG Raid Test Client</h1>
        
        <div class="button-group">
            <button class="raid-button create-raid" id="createRaidBtnEl">
                Create New Raid
            </button>
            <button class="raid-button join-raid" id="joinRaidBtnEl">
                Join Existing Raid
            </button>
        </div>

        <input type="text" 
               class="raid-input" 
               id="raidIdInputEl" 
               placeholder="Enter Raid ID to join">

        <input type="text" 
               class="raid-input" 
               id="usernameInputEl" 
               placeholder="Your username"
               value="TestPlayer123">

        <div class="button-group">
            <button class="raid-button layout-toggle" id="toggleLayoutBtnEl">
                Layout: <span id="currentLayoutSpanEl">versus</span>
            </button>
            <button class="raid-button" id="testMultiplayerBtnEl" style="background: linear-gradient(45deg, #f39c12, #e67e22);">
                üß™ Test Multiplayer (Host)
            </button>
        </div>

        <div class="raid-status" id="raidStatusEl">
Status: Waiting for action... (Ensure server is running and EnhancedRaidClient + dependencies load correctly)
        </div>
    </div>

    <div id="raidContainer">
        <div id="raidTable">
            <div class="versus-indicator" id="layoutIndicatorEl">
                Layout: <span id="layoutNameSpanEl">Versus</span>
            </div>
            <div id="raidPlayersEl"></div>
            <div id="raidBossEl" class="raid-boss">
                <div style="text-align: center;">
                    <div>RAID BOSS</div>
                    <div style="font-size: 16px; opacity: 0.9;">Mysterious Pok√©mon</div>
                    <div style="margin-top: 10px; font-size: 14px;">HP: ??? / ???</div>
                </div>
            </div>
        </div>
    </div>

    <div class="raid-controls" id="raidControlsEl">
        <h3>üéÆ Raid Controls</h3>
        <button class="control-button" id="switchLayoutBtnEl">Switch My View</button>
        <button class="control-button" id="leaveRaidBtnEl">Leave Raid</button>
        <div style="margin-top: 15px;">
            <p>Players: <span id="playerCountSpanEl">0</span>/4</p>
            <p>My View: <span id="controlLayoutSpanEl">versus</span></p>
            <p>Your Angle: <span id="yourAngleSpanEl">-</span>¬∞</p>
            <small style="opacity: 0.7;">Layout is your personal preference</small>
        </div>
    </div>

    <script type="module">
        // Import EnhancedRaidClient from its module file.
        // Path is relative to this HTML file (in 'client/' directory).
        import { EnhancedRaidClient } from './src/raid/EnhancedRaidClient.js';

        window.addEventListener('DOMContentLoaded', () => {
            // DOM Element References
            const raidIdInput = document.getElementById('raidIdInputEl');
            const usernameInput = document.getElementById('usernameInputEl');
            const raidStatus = document.getElementById('raidStatusEl');
            const currentLayoutSpan = document.getElementById('currentLayoutSpanEl');
            const raidLauncherDiv = document.querySelector('.raid-launcher');
            const raidContainerDiv = document.getElementById('raidContainer');
            const raidControlsDiv = document.getElementById('raidControlsEl');
            const raidPlayersDiv = document.getElementById('raidPlayersEl');
            const raidBossDiv = document.getElementById('raidBossEl');
            const layoutIndicatorNameSpan = document.getElementById('layoutNameSpanEl');
            const layoutIndicatorDiv = document.getElementById('layoutIndicatorEl');
            const controlPlayerCountSpan = document.getElementById('playerCountSpanEl');
            const controlLayoutSpan = document.getElementById('controlLayoutSpanEl');
            const controlYourAngleSpan = document.getElementById('yourAngleSpanEl');

            // Button References
            const createRaidBtn = document.getElementById('createRaidBtnEl');
            const joinRaidBtn = document.getElementById('joinRaidBtnEl');
            const toggleLayoutBtn = document.getElementById('toggleLayoutBtnEl');
            const testMultiplayerBtn = document.getElementById('testMultiplayerBtnEl');
            const switchLayoutBtn = document.getElementById('switchLayoutBtnEl');
            const leaveRaidBtn = document.getElementById('leaveRaidBtnEl');

            let raidClientInstance;
            try {
                // EnhancedRaidClient constructor should internally use the 'socket' instance
                // that it imports (via front-end.js from global-variables.js).
                // The global io() function from socket.io.js should have already run.
                raidClientInstance = new EnhancedRaidClient(); 
                window.raidClientInstance = raidClientInstance; // For debugging in console
                log('üöÄ Raid Client Initialized. Waiting for connection...');
            } catch (e) {
                log(`‚ùå FATAL: Error initializing EnhancedRaidClient: ${e.message}. Check console for module loading errors or issues in EnhancedRaidClient/dependencies.`);
                console.error("EnhancedRaidClient instantiation error:", e);
                // Disable all buttons if client fails to initialize
                [createRaidBtn, joinRaidBtn, toggleLayoutBtn, testMultiplayerBtn, switchLayoutBtn, leaveRaidBtn].forEach(btn => {
                    if (btn) btn.disabled = true;
                });
                return; // Stop further script execution if client fails
            }

            let currentRaidDetails = null;   // Holds the full raid state from the server
            let currentPlayerId = null;      // This client's player ID (socket.id or assigned by server)
            let allPlayerPositions = [];     // Server's canonical positions for all players
            let localLayoutPreference = 'versus'; // User's local visual layout preference

            // --- EnhancedRaidClient Event Listeners ---
            // Ensure raidClientInstance is valid before attaching listeners
            if (raidClientInstance && typeof raidClientInstance.on === 'function') {
                raidClientInstance.on('connect', () => {
                    log('üîå Connected to raid server via EnhancedRaidClient.');
                    currentPlayerId = raidClientInstance.socketId || (typeof socket !== 'undefined' ? socket.id : null); // Get client's socket ID
                    log(`My client ID: ${currentPlayerId}`);
                });

                raidClientInstance.on('disconnect', () => {
                    log('üîå Disconnected from raid server.');
                    if (currentRaidDetails) {
                        exitRaidView();
                        currentRaidDetails = null;
                        allPlayerPositions = [];
                    }
                });

                raidClientInstance.on('error', (error) => {
                    const errorMessage = (error && error.message) ? error.message : String(error);
                    log(`‚ùå RaidClient Error: ${errorMessage}`);
                });
                
                // Primary event for receiving full raid state updates
                raidClientInstance.on('raidStateChange', (newState) => {
                    if (!newState || !newState.players || !newState.id) { // Changed newState.raidId to newState.id based on RaidInstance.getState()
                        log('‚ö†Ô∏è Received invalid or incomplete raid state from server.');
                        console.warn('Invalid newState in raidStateChange:', newState);
                        return;
                    }
                    log(`üîÑ Raid state updated for ${newState.id}. Players: ${newState.players.length}, State: ${newState.state}`);

                    currentRaidDetails = newState;
                    allPlayerPositions = newState.playerPositions || [];
                    // EnhancedRaidClient should ideally tell us our player ID within the raid context if it's different from socket.id
                    // For now, we'll rely on the socketId or what the server might send as 'yourPlayerId'
                    currentPlayerId = newState.yourPlayerId || raidClientInstance.socketId || currentPlayerId; 

                    const myPlayerData = currentRaidDetails.players.find(p => p.id === currentPlayerId || p.socketId === currentPlayerId);

                    if ((currentRaidDetails.state === 'active' || currentRaidDetails.state === 'lobby') && myPlayerData) {
                        if (raidLauncherDiv.style.display !== 'none') {
                            enterRaidView();
                        }
                        updatePlayerPositionsWithLayout(localLayoutPreference);
                        updateLayoutIndicators(currentRaidDetails.config?.layout || localLayoutPreference);
                        updateControls(myPlayerData, currentRaidDetails.players.length);
                        updateControlLayout(localLayoutPreference);
                    } else if (raidLauncherDiv.style.display === 'none' && !myPlayerData && currentRaidDetails.state !== 'lobby') {
                        // If we are in raid view but no longer part of an active raid
                        exitRaidView();
                    }
                });
                
                // Specific handler for when this client successfully joins
                // This event might be redundant if 'raidStateChange' provides all necessary info after join
                raidClientInstance.on('raidJoined', (data) => {
                    if (data.success && data.raidState) {
                        log(`‚úÖ Successfully joined raid: ${data.raidId}. Your server-assigned angle: ${data.yourPosition?.angle}¬∞`);
                        // EnhancedRaidClient should ideally manage its internal state and emit 'raidStateChange'
                        // Forcing a state update if not already handled:
                        raidClientInstance.emit('raidStateChange', data.raidState);
                    } else {
                        log(`‚ùå Failed to join raid: ${data.error || 'Unknown reason'}`);
                    }
                });

                raidClientInstance.on('playerJoinedRaid', (data) => {
                     log(`üëã ${data.username || data.playerId} joined. Players: ${data.playerCount}/${data.maxPlayers}`);
                     if (data.raidState) raidClientInstance.emit('raidStateChange', data.raidState);
                });

                raidClientInstance.on('playerLeftRaid', (data) => {
                    log(`üëã ${data.leftPlayerName || data.leftPlayerId} left. Players: ${data.playerCount}`);
                    if (data.raidState) raidClientInstance.emit('raidStateChange', data.raidState);
                });

                raidClientInstance.on('layoutUpdated', (data) => {
                    log(`üîÑ Server confirmed layout: ${data.layout}.`);
                    if (data.positions) allPlayerPositions = data.positions;
                    if (currentRaidDetails && currentRaidDetails.config) currentRaidDetails.config.layout = data.layout;
                    updatePlayerPositionsWithLayout(localLayoutPreference);
                    updateLayoutIndicators(data.layout);
                });

                // Add listeners for game actions if your EnhancedRaidClient emits them
                // Example:
                // raidClientInstance.on('actionResult', (data) => { /* update UI based on action result */ });
                // raidClientInstance.on('turnChange', (turnData) => { /* update turn indicators */ });

            } else {
                log("‚ö†Ô∏è FATAL: EnhancedRaidClient instance is not available. Cannot set up event listeners.");
            }

            function log(message) {
                if (!raidStatus) { console.warn("raidStatus element not found for logging:", message); return; }
                const timestamp = new Date().toLocaleTimeString();
                raidStatus.textContent += `\n[${timestamp}] ${message}`;
                raidStatus.scrollTop = raidStatus.scrollHeight;
            }

            async function handleCreateRaid() {
                if (!raidClientInstance) { log("‚ùå Raid client not initialized."); return; }
                const usernameToJoin = usernameInput.value.trim() || 'HostPlayer';
                log(`üè¥‚Äç‚ò†Ô∏è Attempting to create raid...`);
                try {
                    const raidConfig = {
                        raidType: 'tcg-official', // This should match a type registered in RaidEngine
                        layout: localLayoutPreference,
                        // raidId will be generated by EnhancedRaidClient or server
                    };
                    // createRaid should resolve with details of the created raid, including its ID
                    const creationResponse = await raidClientInstance.createRaid(raidConfig);
                    log(`üëç Raid creation initiated. Server response: ${JSON.stringify(creationResponse)}`);
                    if (creationResponse && creationResponse.success && creationResponse.raidId) {
                        log(`‚úÖ Raid ${creationResponse.raidId} created. Auto-joining as ${usernameToJoin}...`);
                        raidIdInput.value = creationResponse.raidId; // Populate for visibility
                        // EnhancedRaidClient's handleRaidCreated or a direct join call should follow
                        // The provided EnhancedRaidClient seems to auto-join in its 'raidCreated' handler.
                    } else {
                        log(`‚ö†Ô∏è Raid creation might have failed on server or response was unexpected: ${creationResponse.error || 'No raidId in response'}`);
                    }
                } catch (error) {
                    log(`‚ùå Failed to initiate raid creation: ${error.message}`);
                }
            }

            async function handleJoinRaid() {
                if (!raidClientInstance) { log("‚ùå Raid client not initialized."); return; }
                const raidIdToJoin = raidIdInput.value.trim();
                const usernameToJoin = usernameInput.value.trim() || 'Player';
                if (!raidIdToJoin) { log('‚ö†Ô∏è Please enter a Raid ID.'); raidIdInput.focus(); return; }
                log(`üéØ Attempting to join raid: ${raidIdToJoin} as ${usernameToJoin}`);
                try {
                    // joinRaid should resolve once the server confirms the join
                    const joinResponse = await raidClientInstance.joinRaid(raidIdToJoin, usernameToJoin);
                    // The 'raidJoined' and 'raidStateChange' events on raidClientInstance will handle UI updates.
                    log(`üëç Join request sent. Server response: ${JSON.stringify(joinResponse)}`);
                } catch (error) {
                    log(`‚ùå Failed to join raid: ${error.message}`);
                }
            }
            
            async function handleLeaveRaid() {
                if (!raidClientInstance) { log("‚ùå Raid client not initialized."); return; }
                if (raidClientInstance.currentRaid && raidClientInstance.currentRaid.id) {
                    log(`üëã Leaving raid: ${raidClientInstance.currentRaid.id}`);
                    try {
                        await raidClientInstance.leaveRaid();
                    } catch (error) {
                        log(`‚ö†Ô∏è Error during leaveRaid call: ${error.message}`);
                    }
                } else {
                    log("Not currently in a raid to leave (client state).");
                }
                exitRaidView(); // Force UI reset
                currentRaidDetails = null; allPlayerPositions = [];
            }

            async function handleTestMultiplayer() {
                if (!raidClientInstance) { log("‚ùå Raid client not initialized."); return; }
                log('üß™ Simulating multiplayer test (Host perspective)...');
                const hostUsername = usernameInput.value || 'HostPlayer';
                try {
                    const creationResponse = await raidClientInstance.createRaid({ raidType: 'tcg-official', maxPlayers: 4, minPlayers: 1 });
                    if (creationResponse && creationResponse.success && creationResponse.raidId) {
                        log(`üéâ Test Raid Created by Host: ${creationResponse.raidId}. Auto-joining...`);
                        raidIdInput.value = creationResponse.raidId;
                        // EnhancedRaidClient's 'raidCreated' handler should auto-join the host.
                        // If not, you'd call: await raidClientInstance.joinRaid(creationResponse.raidId, hostUsername);
                        log("üì¢ Other players can now join this raid using ID: " + creationResponse.raidId + ". Open this page in other tabs/browsers, enter the ID and a unique username, then click 'Join Existing Raid'.");
                    } else {
                        log(`‚ö†Ô∏è Test Multiplayer: Raid creation failed or no raidId returned: ${creationResponse.error || 'Unknown issue'}`);
                    }
                } catch (error) {
                    log(`‚ùå Error in multiplayer test setup: ${error.message}`);
                }
            }

            function handleToggleLayout() {
                localLayoutPreference = localLayoutPreference === 'versus' ? 'circular' : 'versus';
                if(currentLayoutSpan) currentLayoutSpan.textContent = localLayoutPreference;
                log(`üîÑ Layout preference set to: ${localLayoutPreference}.`);
                if (currentRaidDetails && currentRaidDetails.state === 'active') {
                    switchLayoutVisuals();
                } else if (currentRaidDetails && currentRaidDetails.state === 'lobby' && raidClientInstance.changeLayout) {
                     raidClientInstance.changeLayout(currentRaidDetails.id, localLayoutPreference)
                        .then(() => log(`‚úÖ Layout change to ${localLayoutPreference} requested for lobby.`))
                        .catch(err => log(`‚ö†Ô∏è Could not send layout change for lobby: ${err.message}`));
                }
            }

            function switchLayoutVisuals() {
                if (!currentRaidDetails) return;
                log(`üîÑ Updating YOUR view to: ${localLayoutPreference}`);
                updatePlayerPositionsWithLayout(localLayoutPreference);
                updateLayoutIndicators(localLayoutPreference);
                updateControlLayout(localLayoutPreference);
            }

            function updatePlayerPositionsWithLayout(layoutToDisplay) {
                if (!allPlayerPositions || !currentRaidDetails) { if (raidPlayersDiv) raidPlayersDiv.innerHTML = 'Waiting for player data...'; return; }
                const visuallyAdjustedPositions = recalculatePositionsForLayout(allPlayerPositions, layoutToDisplay);
                displayPlayerPositions(visuallyAdjustedPositions);
                const bossPos = getBossPositionForLayout(layoutToDisplay);
                updateBossPosition(bossPos);
            }

            function recalculatePositionsForLayout(serverPositions, displayLayout) {
                const playerCount = serverPositions.length;
                if (playerCount === 0) return [];
                let angles;
                if (displayLayout === 'circular') {
                    switch (playerCount) { case 1: angles = [0]; break; case 2: angles = [45, 225]; break; case 3: angles = [30, 150, 270]; break; case 4: angles = [45, 135, 225, 315]; break; default: angles = Array.from({length: playerCount}, (_, i) => (360 / playerCount) * i); }
                } else {
                    switch (playerCount) { case 1: angles = [45]; break; case 2: angles = [30, 60]; break; case 3: angles = [15, 45, 75]; break; case 4: angles = [15, 35, 55, 75]; break; default: const s=15,e=75,t=(playerCount>1)?(e-s)/(playerCount-1):0; angles=Array.from({length:playerCount},(_,i)=>s+(t*i));}
                }
                const radius = displayLayout === 'versus' ? 35 : 30;
                return serverPositions.map((originalPos, i) => {
                    const angle = angles[i] !== undefined ? angles[i] : (15 + i * 20);
                    const radians = (angle * Math.PI) / 180;
                    return { ...originalPos, displayAngle: angle, x: Math.max(5, Math.min(95, 50 + radius * Math.cos(radians))), y: Math.max(5, Math.min(95, 50 + radius * Math.sin(radians))) };
                });
            }

            function getBossPositionForLayout(layout) { return layout === 'versus' ? { x: 50, y: 15 } : { x: 50, y: 50 }; }
            function enterRaidView() { if(raidLauncherDiv) raidLauncherDiv.style.display = 'none'; if(raidContainerDiv) raidContainerDiv.style.display = 'block'; if(raidControlsDiv) raidControlsDiv.style.display = 'block'; }
            function exitRaidView() { if(raidLauncherDiv) raidLauncherDiv.style.display = 'block'; if(raidContainerDiv) raidContainerDiv.style.display = 'none'; if(raidControlsDiv) raidControlsDiv.style.display = 'none'; }

            function displayPlayerPositions(positionsToDisplay) {
                if (!raidPlayersDiv) return;
                raidPlayersDiv.innerHTML = '';
                if (!positionsToDisplay || positionsToDisplay.length === 0) { raidPlayersDiv.innerHTML = '<div style="text-align:center; width:100%; margin-top: 40%; color: #ccc;">No players in raid.</div>'; return; }
                positionsToDisplay.forEach((posData, index) => {
                    const el = document.createElement('div');
                    const isMe = posData.playerId === currentPlayerId;
                    el.className = 'raid-player' + (isMe ? ' current-player' : '');
                    const colors = ['linear-gradient(45deg, #e74c3c, #c0392b)', 'linear-gradient(45deg, #3498db, #2980b9)', 'linear-gradient(45deg, #2ecc71, #27ae60)', 'linear-gradient(45deg, #f39c12, #e67e22)'];
                    el.style.background = isMe ? 'linear-gradient(45deg, #f1c40f, #f39c12)' : colors[(posData.serverIndex || index) % colors.length];
                    el.style.left = `${posData.x}%`; el.style.top = `${posData.y}%`;
                    el.innerHTML = `<div style="text-align: center;"><div>${isMe ? 'YOU' : (posData.username || `P${index + 1}`)}</div><div style="font-size: 12px; opacity: 0.8;">${Math.round(posData.displayAngle)}¬∞</div></div>`;
                    const angleInd = document.createElement('div'); angleInd.className = 'angle-indicator'; angleInd.textContent = Math.round(posData.displayAngle); el.appendChild(angleInd);
                    raidPlayersDiv.appendChild(el);
                });
            }

            function updateBossPosition(bossPos) { if (!raidBossDiv || !bossPos) return; raidBossDiv.style.left = `${bossPos.x}%`; raidBossDiv.style.top = `${bossPos.y}%`; }
            function updateControls(myPosData, pCount) {
                if (controlYourAngleSpan && myPosData) controlYourAngleSpan.textContent = Math.round(myPosData.displayAngle || 0); else if(controlYourAngleSpan) controlYourAngleSpan.textContent = '-';
                if(controlPlayerCountSpan) controlPlayerCountSpan.textContent = `${pCount || 0}/${currentRaidDetails?.config?.maxPlayers || 4}`;
            }
            function updateLayoutIndicators(layout) { if(layoutIndicatorNameSpan) layoutIndicatorNameSpan.textContent = layout.charAt(0).toUpperCase()+layout.slice(1); if(layoutIndicatorDiv) layoutIndicatorDiv.className = 'versus-indicator layout-' + layout; }
            function updateControlLayout(layout) { if(controlLayoutSpan) controlLayoutSpan.textContent = layout; }

            function handleKeyPress(event) { if (event.key === 'Enter') { if (raidIdInput && raidIdInput.value) handleJoinRaid(); else handleCreateRaid(); } }
            if(raidIdInput) raidIdInput.addEventListener('keypress', handleKeyPress);

            if(createRaidBtn) createRaidBtn.addEventListener('click', handleCreateRaid);
            if(joinRaidBtn) joinRaidBtn.addEventListener('click', handleJoinRaid);
            if(toggleLayoutBtn) toggleLayoutBtn.addEventListener('click', handleToggleLayout);
            if(testMultiplayerBtn) testMultiplayerBtn.addEventListener('click', handleTestMultiplayer);
            if(switchLayoutBtn) switchLayoutBtn.addEventListener('click', switchLayoutVisuals);
            if(leaveRaidBtn) leaveRaidBtn.addEventListener('click', handleLeaveRaid);

            const params = new URLSearchParams(window.location.search);
            const testPlayerNum = params.get('testPlayer');
            const raidToJoinFromUrl = params.get('testRaid');
            const autoJoinFlag = params.get('autoJoin');
            if (raidToJoinFromUrl && autoJoinFlag === 'true' && testPlayerNum) {
                const usernameForAutoJoin = `TestPlayer${testPlayerNum}`;
                log(`üîó Auto-joining raid ${raidToJoinFromUrl} as ${usernameForAutoJoin} (URL params).`);
                if(usernameInput) usernameInput.value = usernameForAutoJoin; if(raidIdInput) raidIdInput.value = raidToJoinFromUrl;
                let attempts = 0; const maxAttempts = 7, attemptInterval = 1500 + parseInt(testPlayerNum) * 300;
                async function attemptAutoJoin() {
                    if (!raidClientInstance || raidClientInstance.connectionState !== 'connected') {
                        log(`‚è≥ Raid client not ready/connected for auto-join (attempt ${attempts+1}), retrying...`);
                        if(attempts < maxAttempts) { attempts++; setTimeout(attemptAutoJoin, attemptInterval); } else {log("‚ùå Max auto-join attempts (client not ready/connected).");} return;
                    }
                    attempts++;
                    try {
                        log(`üöÄ Attempting auto-join ${attempts} for ${usernameForAutoJoin} to raid ${raidToJoinFromUrl}`);
                        await raidClientInstance.joinRaid(raidToJoinFromUrl, usernameForAutoJoin);
                    } catch (error) {
                        log(`‚ö†Ô∏è Auto-join attempt ${attempts} failed: ${error.message}`);
                        if (attempts < maxAttempts) { setTimeout(attemptAutoJoin, attemptInterval + 1000); } else { log(`‚ùå Max auto-join attempts for ${usernameForAutoJoin}.`);}
                    }
                }
                setTimeout(attemptAutoJoin, 1000); // Initial delay for client to connect
            } else if (raidToJoinFromUrl) {
                if(raidIdInput) raidIdInput.value = raidToJoinFromUrl;
                if(usernameInput) usernameInput.value = `Player${Math.floor(Math.random()*1000)}`;
                log(`üìã Raid ID ${raidToJoinFromUrl} pre-filled from URL. Enter username & click 'Join Raid'.`);
            }
            log("Optimized client script initialized and DOM ready.");
        });
    </script>
</body>
</html>