<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PTCG Raid System - Test Client</title>
    <style>
        body { margin: 0; padding: 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
        .raid-launcher { background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 30px; max-width: 600px; margin: 40px auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); backdrop-filter: blur(10px); }
        .raid-launcher h1 { text-align: center; color: #333; margin-bottom: 30px; font-size: 28px; }
        .button-group { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .raid-button { flex: 1 1 auto; min-width: 150px; padding: 15px 20px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 1px; }
        .create-raid { background: linear-gradient(45deg, #ff6b6b, #ee5a24); color: white; }
        .join-raid { background: linear-gradient(45deg, #4ecdc4, #44a08d); color: white; }
        .layout-toggle { background: linear-gradient(45deg, #a55eea, #8e44ad); color: white; }
        .test-button { background: linear-gradient(45deg, #f39c12, #e67e22); color: white; }
        .raid-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); }
        .raid-button:disabled { opacity: 0.6; cursor: not-allowed; }
        .raid-input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 15px; box-sizing: border-box; }
        .raid-status { background: rgba(255, 255, 255, 0.8); color: #333; padding: 15px; border-radius: 8px; margin-top: 20px; min-height: 150px; font-family: monospace; font-size: 14px; white-space: pre-wrap; overflow-y: auto; max-height: 300px; border: 1px solid #eee; }
        .error { color: #e74c3c; font-weight: bold; }
        .success { color: #27ae60; font-weight: bold; }
        .warning { color: #f39c12; font-weight: bold; }

        /* Raid Visual Interface */
        #raidContainer { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: linear-gradient(45deg, #2c3e50 0%, #3498db 100%); display: none; z-index: 1000; perspective: 1000px; color: white; }
        #raidTable { position: absolute; top: 50%; left: 50%; width: 90vw; height: 90vh; background: radial-gradient(circle at center, rgba(255,255,255,0.05) 0%, transparent 40%), linear-gradient(45deg, #34495e 0%, #2c3e50 100%); border-radius: 20px; transform: translate(-50%, -50%) perspective(1000px) rotateX(10deg); box-shadow: 0 20px 60px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1); overflow: hidden; }
        .raid-player { position: absolute; width: 120px; height: 80px; border: 3px solid #fff; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); transition: all 0.3s ease; cursor: pointer; }
        .raid-player:hover { transform: translate(-50%, -50%) scale(1.1) !important; }
        .raid-player.current-player { border-color: #f1c40f; box-shadow: 0 5px 15px rgba(0,0,0,0.3), 0 0 20px rgba(241,196,15,0.6); }
        .raid-boss { position: absolute; width: 180px; height: 270px; background: radial-gradient(circle, #e74c3c 0%, #c0392b 100%); border: 3px solid #fff; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-size: 20px; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.7); transform: translate(-50%, -50%); animation: bossIdle 4s ease-in-out infinite; padding: 10px; box-sizing: border-box; }
        @keyframes bossIdle { 0%, 100% { transform: translate(-50%, -50%) translateY(0px) scale(1); } 50% { transform: translate(-50%, -50%) translateY(-5px) scale(1.02); } }
        .raid-controls { position: fixed; top: 20px; right: 20px; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px; color: white; z-index: 1001; display: none; max-width: 300px; }
        .control-button { background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; margin: 5px 0; width: 100%; transition: all 0.3s ease; }
        .control-button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .angle-indicator { position: absolute; top: -10px; right: -10px; width: 25px; height: 25px; background: rgba(255,255,255,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #333; font-weight: bold; }
        .versus-indicator { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 8px 15px; border-radius: 20px; font-size: 14px; z-index: 10; }
        .layout-versus { background: linear-gradient(45deg, #e74c3c 0%, #c0392b 100%); }
        .layout-circular { background: linear-gradient(45deg, #3498db 0%, #2980b9 100%); }

        /* Game Action Buttons */
        .game-actions { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px; display: none; z-index: 1001; }
        .action-btn { background: linear-gradient(45deg, #2ecc71, #27ae60); color: white; border: none; padding: 8px 15px; margin: 0 5px; border-radius: 5px; cursor: pointer; font-size: 12px; transition: all 0.3s ease; }
        .action-btn:hover { transform: translateY(-1px); }
        .action-btn.attack { background: linear-gradient(45deg, #e74c3c, #c0392b); }
        .action-btn.retreat { background: linear-gradient(45deg, #9b59b6, #8e44ad); }
        .action-btn.cheer { background: linear-gradient(45deg, #f39c12, #e67e22); }
    </style>
</head>
<body>
    <!-- Preserve existing iframe structure -->
    <iframe id="selfContainer" style="display: none; width:0; height:0;" title="self container"></iframe>
    <iframe id="oppContainer" style="display: none; width:0; height:0;" title="opp container"></iframe>

    <div class="raid-launcher">
        <h1>üè¥‚Äç‚ò†Ô∏è PTCG Raid Battle System</h1>
        
        <div class="button-group">
            <button class="raid-button create-raid" id="createRaidBtn">Create New Raid</button>
            <button class="raid-button join-raid" id="joinRaidBtn">Join Existing Raid</button>
        </div>

        <input type="text" class="raid-input" id="raidIdInput" placeholder="Enter Raid ID to join">
        <input type="text" class="raid-input" id="usernameInput" placeholder="Your username" value="TestPlayer123">

        <div class="button-group">
            <button class="raid-button layout-toggle" id="toggleLayoutBtn">Layout: <span id="currentLayoutSpan">versus</span></button>
            <button class="raid-button test-button" id="testMultiplayerBtn">üß™ Test Multiplayer</button>
        </div>

        <div class="button-group">
            <button class="raid-button test-button" id="quickTestBtn">‚ö° Quick Test</button>
            <button class="raid-button test-button" id="stressTestBtn">üî• Stress Test</button>
        </div>

        <div class="raid-status" id="raidStatus">
üöÄ PTCG Raid System Ready

üìã Instructions:
1. Start server: node server/raid-test-server.js (or raid-integration-demo.js)
2. Create raid or join existing one
3. Test multiplayer by opening multiple tabs

‚ö†Ô∏è Status: <span id="connectionStatus">Connecting...</span>
        </div>
    </div>

    <!-- Raid Visual Interface -->
    <div id="raidContainer">
        <div id="raidTable">
            <div class="versus-indicator" id="layoutIndicator">
                Layout: <span id="layoutName">Versus</span>
            </div>
            <div id="raidPlayers"></div>
            <div id="raidBoss" class="raid-boss">
                <div style="text-align: center;">
                    <div>RAID BOSS</div>
                    <div style="font-size: 16px; opacity: 0.9;" id="bossName">Mysterious Pok√©mon</div>
                    <div style="margin-top: 10px; font-size: 14px;" id="bossHP">HP: ??? / ???</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Raid Controls -->
    <div class="raid-controls" id="raidControls">
        <h3>üéÆ Raid Controls</h3>
        <button class="control-button" id="switchLayoutBtn">Switch Layout</button>
        <button class="control-button" id="leaveRaidBtn">Leave Raid</button>
        <div style="margin-top: 15px; font-size: 14px;">
            <p>Players: <span id="playerCount">0</span>/4</p>
            <p>Layout: <span id="controlLayout">versus</span></p>
            <p>Your Angle: <span id="yourAngle">-</span>¬∞</p>
            <p>Status: <span id="raidPhase">Lobby</span></p>
        </div>
    </div>

    <!-- Game Actions -->
    <div class="game-actions" id="gameActions">
        <button class="action-btn attack" id="attackBtn">‚öîÔ∏è Attack (60)</button>
        <button class="action-btn retreat" id="retreatBtn">üîÑ Retreat</button>
        <button class="action-btn cheer" id="cheerBtn">‚ú® Cheer</button>
        <button class="action-btn" id="testKOBtn">üíÄ Test KO</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Complete Raid Client Implementation
        class RaidTestClient {
            constructor() {
                this.socket = io();
                this.currentRaid = null;
                this.playerPosition = null;
                this.allPositions = [];
                this.bossPosition = null;
                this.isInRaid = false;
                this.currentLayout = 'versus';
                this.connectionStatus = 'connecting';
                
                this.initializeDOM();
                this.setupSocketListeners();
                this.setupEventListeners();
                
                console.log('üöÄ Raid Test Client initialized');
            }

            initializeDOM() {
                // Get all DOM elements
                this.elements = {
                    // Launcher elements
                    createRaidBtn: document.getElementById('createRaidBtn'),
                    joinRaidBtn: document.getElementById('joinRaidBtn'),
                    testMultiplayerBtn: document.getElementById('testMultiplayerBtn'),
                    quickTestBtn: document.getElementById('quickTestBtn'),
                    stressTestBtn: document.getElementById('stressTestBtn'),
                    toggleLayoutBtn: document.getElementById('toggleLayoutBtn'),
                    
                    // Inputs
                    raidIdInput: document.getElementById('raidIdInput'),
                    usernameInput: document.getElementById('usernameInput'),
                    
                    // Status and display
                    raidStatus: document.getElementById('raidStatus'),
                    connectionStatus: document.getElementById('connectionStatus'),
                    currentLayoutSpan: document.getElementById('currentLayoutSpan'),
                    
                    // Raid interface
                    raidContainer: document.getElementById('raidContainer'),
                    raidLauncher: document.querySelector('.raid-launcher'),
                    raidControls: document.getElementById('raidControls'),
                    gameActions: document.getElementById('gameActions'),
                    
                    // Raid display elements
                    raidPlayers: document.getElementById('raidPlayers'),
                    raidBoss: document.getElementById('raidBoss'),
                    layoutIndicator: document.getElementById('layoutIndicator'),
                    layoutName: document.getElementById('layoutName'),
                    
                    // Control elements
                    switchLayoutBtn: document.getElementById('switchLayoutBtn'),
                    leaveRaidBtn: document.getElementById('leaveRaidBtn'),
                    playerCount: document.getElementById('playerCount'),
                    controlLayout: document.getElementById('controlLayout'),
                    yourAngle: document.getElementById('yourAngle'),
                    raidPhase: document.getElementById('raidPhase'),
                    
                    // Boss info
                    bossName: document.getElementById('bossName'),
                    bossHP: document.getElementById('bossHP'),
                    
                    // Action buttons
                    attackBtn: document.getElementById('attackBtn'),
                    retreatBtn: document.getElementById('retreatBtn'),
                    cheerBtn: document.getElementById('cheerBtn'),
                    testKOBtn: document.getElementById('testKOBtn')
                };
            }

            setupSocketListeners() {
                this.socket.on('connect', () => {
                    this.connectionStatus = 'connected';
                    this.updateConnectionStatus('Connected', 'success');
                    console.log('üîå Connected to raid server');
                });

                this.socket.on('disconnect', () => {
                    this.connectionStatus = 'disconnected';
                    this.updateConnectionStatus('Disconnected', 'error');
                    console.log('üîå Disconnected from server');
                });

                this.socket.on('raidCreated', (data) => this.handleRaidCreated(data));
                this.socket.on('raidJoined', (data) => this.handleRaidJoined(data));
                this.socket.on('raidJoinFailed', (data) => this.handleRaidJoinFailed(data));
                this.socket.on('playerJoinedRaid', (data) => this.handlePlayerJoined(data));
                this.socket.on('playerLeftRaid', (data) => this.handlePlayerLeft(data));
                this.socket.on('layoutUpdated', (data) => this.handleLayoutUpdate(data));
                this.socket.on('raidActionResult', (data) => this.handleActionResult(data));
                this.socket.on('raidActionFailed', (data) => this.handleActionFailed(data));
                this.socket.on('gameEnded', (data) => this.handleGameEnd(data));
            }

            setupEventListeners() {
                // Launcher buttons
                if (this.elements.createRaidBtn) {
                    this.elements.createRaidBtn.addEventListener('click', () => this.createRaid());
                }
                if (this.elements.joinRaidBtn) {
                    this.elements.joinRaidBtn.addEventListener('click', () => this.joinRaid());
                }
                if (this.elements.testMultiplayerBtn) {
                    this.elements.testMultiplayerBtn.addEventListener('click', () => this.testMultiplayer());
                }
                if (this.elements.quickTestBtn) {
                    this.elements.quickTestBtn.addEventListener('click', () => this.quickTest());
                }
                if (this.elements.stressTestBtn) {
                    this.elements.stressTestBtn.addEventListener('click', () => this.stressTest());
                }
                if (this.elements.toggleLayoutBtn) {
                    this.elements.toggleLayoutBtn.addEventListener('click', () => this.toggleLayout());
                }

                // Control buttons
                if (this.elements.switchLayoutBtn) {
                    this.elements.switchLayoutBtn.addEventListener('click', () => this.switchLayout());
                }
                if (this.elements.leaveRaidBtn) {
                    this.elements.leaveRaidBtn.addEventListener('click', () => this.leaveRaid());
                }

                // Action buttons
                if (this.elements.attackBtn) {
                    this.elements.attackBtn.addEventListener('click', () => this.sendRaidAction('playerAttack', { pokemon: 'active', attackName: 'Thunder Shock', damage: 60 }));
                }
                if (this.elements.retreatBtn) {
                    this.elements.retreatBtn.addEventListener('click', () => this.sendRaidAction('playerRetreat', {}));
                }
                if (this.elements.cheerBtn) {
                    this.elements.cheerBtn.addEventListener('click', () => this.sendRaidAction('cheerCard', { cardNumber: 2 }));
                }
                if (this.elements.testKOBtn) {
                    this.elements.testKOBtn.addEventListener('click', () => this.sendRaidAction('testKO', { pokemon: 'active' }));
                }

                // Enter key support
                if (this.elements.raidIdInput) {
                    this.elements.raidIdInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') this.joinRaid();
                    });
                }
            }

            // Socket Event Handlers
            handleRaidCreated(data) {
                if (data.success) {
                    this.log(`üè¥‚Äç‚ò†Ô∏è Raid created: ${data.raidId}`, 'success');
                    if (this.elements.raidIdInput) {
                        this.elements.raidIdInput.value = data.raidId;
                    }
                    // Auto-join the created raid
                    setTimeout(() => this.joinRaid(data.raidId), 1000);
                } else {
                    this.log(`‚ùå Failed to create raid: ${data.error}`, 'error');
                }
            }

            handleRaidJoined(data) {
                if (data.success) {
                    this.log(`‚úÖ Joined raid successfully`, 'success');
                    this.currentRaid = data.raidState;
                    this.playerPosition = data.yourPosition;
                    this.allPositions = data.allPositions || [];
                    this.bossPosition = data.bossPosition;
                    this.isInRaid = true;

                    if (this.playerPosition && this.playerPosition.angle !== undefined) {
                        this.log(`üéØ Your position: ${Math.round(this.playerPosition.angle)}¬∞`);
                    }

                    this.enterRaidView();
                    this.updateRaidDisplay();
                } else {
                    this.log(`‚ùå Failed to join raid: ${data.error}`, 'error');
                }
            }

            handleRaidJoinFailed(data) {
                this.log(`‚ùå Join failed: ${data.error}`, 'error');
            }

            handlePlayerJoined(data) {
                this.log(`üëã ${data.username} joined (${data.playerCount}/${data.maxPlayers})`);
                this.allPositions = data.positions || [];
                this.bossPosition = data.bossPosition;
                this.updateRaidDisplay();
            }

            handlePlayerLeft(data) {
                this.log(`üëã ${data.leftPlayerName} left (${data.playerCount} remaining)`);
                this.allPositions = data.newPositions || [];
                this.updateRaidDisplay();
            }

            handleLayoutUpdate(data) {
                this.log(`üîÑ Layout updated: ${data.layout}`);
                this.allPositions = data.positions || [];
                this.bossPosition = data.bossPosition;
                this.updateRaidDisplay();
            }

            handleActionResult(data) {
                this.log(`üéÆ Action: ${data.action.type} - ${data.result.message || 'Success'}`);
                if (data.result.newBossHP !== undefined) {
                    this.updateBossHP(data.result.newBossHP);
                }
                if (data.result.bossDefeated) {
                    this.log('üéâ Boss defeated!', 'success');
                }
            }

            handleActionFailed(data) {
                this.log(`‚ùå Action failed: ${data.error}`, 'error');
            }

            handleGameEnd(data) {
                const message = data.victory ? 'üéâ Victory!' : 'üíÄ Defeat!';
                this.log(`${message} ${data.reason}`, data.victory ? 'success' : 'error');
            }

            // Raid Operations
            createRaid() {
                if (this.connectionStatus !== 'connected') {
                    this.log('‚ùå Not connected to server', 'error');
                    return;
                }

                const raidId = 'raid-' + Date.now() + '-' + Math.random().toString(36).substring(2, 8);
                this.log(`üè¥‚Äç‚ò†Ô∏è Creating raid: ${raidId}`);

                this.socket.emit('createRaid', {
                    raidId: raidId,
                    raidType: 'tcg-official',
                    maxPlayers: 4,
                    layout: this.currentLayout
                });
            }

            joinRaid(raidId = null) {
                if (this.connectionStatus !== 'connected') {
                    this.log('‚ùå Not connected to server', 'error');
                    return;
                }

                const targetRaidId = raidId || (this.elements.raidIdInput ? this.elements.raidIdInput.value.trim() : '');
                const username = this.elements.usernameInput ? this.elements.usernameInput.value.trim() || 'TestPlayer' : 'TestPlayer';

                if (!targetRaidId) {
                    this.log('‚ùå Please enter a Raid ID', 'error');
                    if (this.elements.raidIdInput) this.elements.raidIdInput.focus();
                    return;
                }

                this.log(`üéØ Joining raid: ${targetRaidId} as ${username}`);

                this.socket.emit('joinRaid', {
                    raidId: targetRaidId,
                    username: username,
                    pokemon: {
                        active: { name: 'Pikachu', hp: 120, maxHP: 120, attacks: [{ name: 'Thunder Shock', damage: 60 }] },
                        bench: { name: 'Squirtle', hp: 100, maxHP: 100, attacks: [{ name: 'Water Gun', damage: 50 }] }
                    }
                });
            }

            leaveRaid() {
                if (this.currentRaid) {
                    this.socket.emit('leaveRaid', { raidId: this.currentRaid.id });
                }
                this.exitRaidView();
                this.currentRaid = null;
                this.isInRaid = false;
                this.log('üëã Left raid');
            }

            sendRaidAction(actionType, data) {
                if (!this.currentRaid) {
                    this.log('‚ùå Not in a raid', 'error');
                    return;
                }

                this.socket.emit('raidAction', {
                    raidId: this.currentRaid.id,
                    action: { type: actionType, ...data }
                });
            }

            // Layout Management
            toggleLayout() {
                this.currentLayout = this.currentLayout === 'versus' ? 'circular' : 'versus';
                if (this.elements.currentLayoutSpan) {
                    this.elements.currentLayoutSpan.textContent = this.currentLayout;
                }
                this.log(`üîÑ Layout preference: ${this.currentLayout}`);
            }

            switchLayout() {
                this.toggleLayout();
                if (this.isInRaid) {
                    this.updateRaidDisplay();
                }
            }

            // Test Functions
            quickTest() {
                this.log('‚ö° Running quick test...', 'success');
                this.createRaid();
            }

            testMultiplayer() {
                this.log('üß™ Setting up multiplayer test...', 'success');
                this.createRaid();
                setTimeout(() => {
                    const raidId = this.elements.raidIdInput ? this.elements.raidIdInput.value : '';
                    if (raidId) {
                        this.log(`üì¢ Multiplayer Raid ID: ${raidId}`, 'success');
                        this.log('üìã Open new tabs and join with this ID for multiplayer testing');
                    }
                }, 2000);
            }

            stressTest() {
                this.log('üî• Running stress test...', 'warning');
                this.createRaid();
                setTimeout(() => {
                    // Rapid action testing
                    let actionCount = 0;
                    const interval = setInterval(() => {
                        if (actionCount >= 10 || !this.isInRaid) {
                            clearInterval(interval);
                            this.log('üî• Stress test completed', 'success');
                            return;
                        }
                        this.sendRaidAction('playerAttack', { pokemon: 'active', damage: 25 });
                        actionCount++;
                    }, 500);
                }, 3000);
            }

            // UI Management
            enterRaidView() {
                if (this.elements.raidLauncher) this.elements.raidLauncher.style.display = 'none';
                if (this.elements.raidContainer) this.elements.raidContainer.style.display = 'block';
                if (this.elements.raidControls) this.elements.raidControls.style.display = 'block';
                if (this.elements.gameActions) this.elements.gameActions.style.display = 'block';
            }

            exitRaidView() {
                if (this.elements.raidLauncher) this.elements.raidLauncher.style.display = 'block';
                if (this.elements.raidContainer) this.elements.raidContainer.style.display = 'none';
                if (this.elements.raidControls) this.elements.raidControls.style.display = 'none';
                if (this.elements.gameActions) this.elements.gameActions.style.display = 'none';
            }

            updateRaidDisplay() {
                this.updatePlayerPositions();
                this.updateBossPosition();
                this.updateControlInfo();
                this.updateLayoutIndicators();
            }

            updatePlayerPositions() {
                if (!this.elements.raidPlayers || !this.allPositions) return;

                this.elements.raidPlayers.innerHTML = '';

                this.allPositions.forEach((position, index) => {
                    const playerElement = document.createElement('div');
                    const isCurrentPlayer = position.playerId === this.socket.id;
                    
                    playerElement.className = 'raid-player' + (isCurrentPlayer ? ' current-player' : '');
                    
                    const colors = [
                        'linear-gradient(45deg, #e74c3c, #c0392b)',
                        'linear-gradient(45deg, #3498db, #2980b9)', 
                        'linear-gradient(45deg, #2ecc71, #27ae60)',
                        'linear-gradient(45deg, #f39c12, #e67e22)'
                    ];
                    
                    playerElement.style.background = isCurrentPlayer ? 
                        'linear-gradient(45deg, #f1c40f, #f39c12)' : 
                        colors[index % colors.length];
                    
                    playerElement.style.left = `${position.x}%`;
                    playerElement.style.top = `${position.y}%`;
                    playerElement.style.transform = 'translate(-50%, -50%)';
                    
                    playerElement.innerHTML = `
                        <div style="text-align: center;">
                            <div>${isCurrentPlayer ? 'YOU' : `Player ${index + 1}`}</div>
                            <div style="font-size: 12px; opacity: 0.8;">${Math.round(position.angle)}¬∞</div>
                        </div>
                    `;

                    const angleIndicator = document.createElement('div');
                    angleIndicator.className = 'angle-indicator';
                    angleIndicator.textContent = Math.round(position.angle);
                    playerElement.appendChild(angleIndicator);

                    this.elements.raidPlayers.appendChild(playerElement);
                });
            }

            updateBossPosition() {
                if (!this.elements.raidBoss || !this.bossPosition) return;
                
                this.elements.raidBoss.style.left = `${this.bossPosition.x}%`;
                this.elements.raidBoss.style.top = `${this.bossPosition.y}%`;
            }

            updateBossHP(currentHP, maxHP = 1000) {
                if (this.elements.bossHP) {
                    this.elements.bossHP.textContent = `HP: ${currentHP} / ${maxHP}`;
                }
            }

            updateControlInfo() {
                if (this.elements.playerCount && this.allPositions) {
                    this.elements.playerCount.textContent = `${this.allPositions.length}/4`;
                }
                if (this.elements.controlLayout) {
                    this.elements.controlLayout.textContent = this.currentLayout;
                }
                if (this.elements.yourAngle && this.playerPosition) {
                    this.elements.yourAngle.textContent = Math.round(this.playerPosition.angle || 0);
                }
                if (this.elements.raidPhase) {
                    this.elements.raidPhase.textContent = this.isInRaid ? 'Active' : 'Lobby';
                }
            }

            updateLayoutIndicators() {
                if (this.elements.layoutName) {
                    this.elements.layoutName.textContent = this.currentLayout.charAt(0).toUpperCase() + this.currentLayout.slice(1);
                }
                if (this.elements.layoutIndicator) {
                    this.elements.layoutIndicator.className = `versus-indicator layout-${this.currentLayout}`;
                }
            }

            updateConnectionStatus(status, type = 'info') {
                if (this.elements.connectionStatus) {
                    this.elements.connectionStatus.textContent = status;
                    this.elements.connectionStatus.className = type;
                }
            }

            log(message, type = 'info') {
                if (!this.elements.raidStatus) return;
                
                const timestamp = new Date().toLocaleTimeString();
                const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
                const span = className ? `<span class="${className}">` : '<span>';
                
                this.elements.raidStatus.innerHTML += `\n[${timestamp}] ${span}${message}</span>`;
                this.elements.raidStatus.scrollTop = this.elements.raidStatus.scrollHeight;
            }
        }

        // Initialize the raid client when page loads
        let raidClient;
        
        window.addEventListener('load', () => {
            try {
                raidClient = new RaidTestClient();
                window.raidClient = raidClient; // Make available globally for debugging
            } catch (error) {
                console.error('Failed to initialize raid client:', error);
                const statusEl = document.getElementById('raidStatus');
                if (statusEl) {
                    statusEl.innerHTML += `\n‚ùå FATAL ERROR: ${error.message}`;
                }
            }
        });

        // URL parameter handling for automated testing
        const urlParams = new URLSearchParams(window.location.search);
        const autoJoin = urlParams.get('autoJoin');
        const testRaid = urlParams.get('testRaid');
        const testPlayer = urlParams.get('testPlayer');

        if (autoJoin === 'true' && testRaid && testPlayer) {
            window.addEventListener('load', () => {
                setTimeout(() => {
                    if (raidClient && raidClient.connectionStatus === 'connected') {
                        const usernameInput = document.getElementById('usernameInput');
                        const raidIdInput = document.getElementById('raidIdInput');
                        
                        if (usernameInput) usernameInput.value = `TestPlayer${testPlayer}`;
                        if (raidIdInput) raidIdInput.value = testRaid;
                        
                        raidClient.joinRaid(testRaid);
                    }
                }, 2000);
            });
        }
    </script>
</body>
</html>